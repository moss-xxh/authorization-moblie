<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>授权书 - 移动版</title>
    
    <!-- 紧急修复脚本 -->
    <script>
        function testClick() {
            alert('点击成功！JavaScript正常工作');
        }
        
        
        function openQueryPage() {
            // 隐藏表单页面
            const formPage = document.getElementById('form-page');
            const queryPage = document.getElementById('query-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            if (formPage) formPage.classList.add('hidden');
            if (queryPage) queryPage.classList.remove('hidden');
            if (submitBtnContainer) submitBtnContainer.classList.add('hidden');
            
            console.log('查询页面已显示');
        }
        
        function closeQueryPage() {
            console.log('closeQueryPage 开始执行');
            
            // 显示表单页面
            const formPage = document.getElementById('form-page');
            const queryPage = document.getElementById('query-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            console.log('找到的元素:', {
                formPage: !!formPage,
                queryPage: !!queryPage,
                submitBtnContainer: !!submitBtnContainer
            });
            
            if (formPage) {
                formPage.style.display = 'block';
                formPage.classList.remove('hidden');
                console.log('显示表单页面');
            }
            if (queryPage) {
                queryPage.style.display = 'none';
                queryPage.classList.add('hidden');
                console.log('隐藏查询页面');
            }
            // 不显示提交按钮容器，因为从查询页面返回时不需要显示Submit按钮
            if (submitBtnContainer) {
                submitBtnContainer.classList.add('hidden');
                console.log('隐藏提交按钮');
            }
            
            console.log('查询页面已关闭');
        }
        
        function editQueryResult() {
            console.log('编辑查询结果');
            
            // 隐藏详情页面，显示表单页面
            const detailPage = document.getElementById('detail-page');
            const formPage = document.getElementById('form-page');
            const queryPage = document.getElementById('query-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            console.log('找到的元素:', {
                detailPage: !!detailPage,
                formPage: !!formPage,
                queryPage: !!queryPage,
                submitBtnContainer: !!submitBtnContainer
            });
            
            // 隐藏详情页面和查询页面
            if (detailPage) {
                detailPage.style.display = 'none';
                detailPage.classList.add('hidden');
                console.log('隐藏详情页面');
            }
            if (queryPage) {
                queryPage.style.display = 'none';
                queryPage.classList.add('hidden');
                console.log('隐藏查询页面');
            }
            
            // 显示表单页面
            if (formPage) {
                formPage.style.display = 'block';
                formPage.classList.remove('hidden');
                console.log('显示表单页面');
            }
            
            // 不显示Submit按钮，用户处于纯编辑模式
            if (submitBtnContainer) {
                submitBtnContainer.style.display = 'none';
                submitBtnContainer.classList.add('hidden');
                console.log('隐藏提交按钮');
            }
            
            console.log('已进入编辑模式');
        }
        
        function goBackToRecordList() {
            console.log('返回记录列表');
            // 重新执行查询以显示记录列表
            performQuery();
        }
        
        function backToQuery() {
            console.log('从详情页面返回到查询页面');
            
            // 隐藏详情页面，显示查询页面
            const detailPage = document.getElementById('detail-page');
            const queryPage = document.getElementById('query-page');
            
            if (detailPage) detailPage.classList.add('hidden');
            if (queryPage) queryPage.classList.remove('hidden');
        }
        
        function performQuery() {
            console.log('执行查询');
            
            // 简化的查询结果显示
            const queryResult = document.getElementById('query-result');
            const noDataMessage = document.getElementById('no-data-message');
            const resultContent = document.getElementById('query-result-content');
            
            // 模拟查询结果
            const scenarios = ['two_records', 'single_record', 'fail'];
            const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            
            if (randomScenario === 'fail') {
                if (queryResult) queryResult.classList.add('hidden');
                if (noDataMessage) noDataMessage.classList.remove('hidden');
            } else {
                if (noDataMessage) noDataMessage.classList.add('hidden');
                if (queryResult) queryResult.classList.remove('hidden');
                
                if (resultContent) {
                    if (randomScenario === 'two_records') {
                        resultContent.innerHTML = `
                            <div class="space-y-3">
                                <div class="card-apple p-4">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-medium" data-i18n="submit_time">Submit Time</div>
                                            <div class="text-xs text-gray-500">2025-09-05 14:30:22</div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600" data-i18n="authorized">Authorized</span>
                                            <button onclick="showRecordDetail('record1')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded" data-i18n="view_details">View Details</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-apple p-4">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-medium" data-i18n="submit_time">Submit Time</div>
                                            <div class="text-xs text-gray-500">2025-09-04 16:45:18</div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-600" data-i18n="authorizing">Authorizing</span>
                                            <button onclick="showRecordDetail('record2')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded" data-i18n="view_details">View Details</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        resultContent.innerHTML = `
                            <div class="card-apple p-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-sm font-medium" data-i18n="submit_time">Submit Time</div>
                                        <div class="text-xs text-gray-500">2025-09-05 09:15:33</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600" data-i18n="authorized">Authorized</span>
                                        <button onclick="showRecordDetail('record3')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded" data-i18n="view_details">View Details</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // 应用当前语言翻译到新生成的内容
            if (typeof changeLanguage === 'function' && window.currentLang) {
                setTimeout(() => changeLanguage(window.currentLang), 50);
            }
        }
        
        function showRecordDetail(recordId) {
            console.log('显示记录详情:', recordId);
            
            // 隐藏查询页面，显示详情页面
            const queryPage = document.getElementById('query-page');
            const detailPage = document.getElementById('detail-page');
            const detailContent = document.getElementById('detail-content');
            
            if (queryPage) queryPage.classList.add('hidden');
            if (detailPage) detailPage.classList.remove('hidden');
            
            const mockNames = ['John Smith', 'Mike Johnson', 'Sarah Wilson', 'David Brown'];
            const mockEmails = ['user1@example.com', 'test@gmail.com', 'demo@qq.com'];
            const mockAddresses = ['123 CBD Street, Sydney NSW 2000', '456 South Yarra Ave, Melbourne VIC 3141', '789 Queensland Road, Brisbane QLD 4000'];
            const installerNames = ['John Smith', 'Mike Johnson', 'David Brown'];
            const installerCompanies = ['Solar Install Pro', 'Green Energy Solutions', 'Power Tech Systems'];
            
            const mockCustomerName = mockNames[Math.floor(Math.random() * mockNames.length)];
            const mockMobile = `04${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`;
            const mockEmail = mockEmails[Math.floor(Math.random() * mockEmails.length)];
            const mockNMI = `NMI${Math.floor(Math.random() * 10000000000).toString().padStart(10, '0')}`;
            const mockAddress = mockAddresses[Math.floor(Math.random() * mockAddresses.length)];
            const mockBrand = 'FOX ESS';
            const mockAccount = `ACC${Math.floor(Math.random() * 100000).toString().padStart(6, '0')}`;
            const mockInverterSN = `INV${Math.floor(Math.random() * 1000000).toString().padStart(8, '0')}`;
            const mockBatterySN = `BAT${Math.floor(Math.random() * 1000000).toString().padStart(8, '0')}`;
            const mockCapacity = `${Math.floor(Math.random() * 50 + 10)}kWh`;
            const mockInstallerName = installerNames[Math.floor(Math.random() * installerNames.length)];
            const mockInstallerCompany = installerCompanies[Math.floor(Math.random() * installerCompanies.length)];
            const mockInstallerLicense = `LIC${Math.floor(Math.random() * 100000).toString().padStart(6, '0')}`;
            
            // 根据记录ID设置不同的状态和按钮
            let statusClass, statusText, buttonHTML;
            
            if (recordId === 'authorizing') {
                // 授权中，有编辑按钮
                statusClass = 'bg-warning/10 text-warning';
                statusText = translations[currentLang].authorizing || 'Authorizing';
                buttonHTML = `
                    <button onclick="editQueryResult()" class="btn-outline-black w-full">
                        <i class="fa fa-pencil mr-2"></i>
                        <span data-i18n="edit_info">修改信息</span>
                    </button>
                `;
            } else if (recordId === 'authorized') {
                // 已授权，有编辑按钮
                statusClass = 'bg-success/10 text-success';
                statusText = translations[currentLang].authorized || 'Authorized';
                buttonHTML = `
                    <button onclick="editQueryResult()" class="btn-outline-black w-full">
                        <i class="fa fa-pencil mr-2"></i>
                        <span data-i18n="edit_info">修改信息</span>
                    </button>
                `;
            } else if (recordId === 'rejected') {
                // 已驳回，重新提交按钮
                statusClass = 'bg-danger/10 text-danger';
                statusText = translations[currentLang].rejected || 'Rejected';
                buttonHTML = `
                    <button onclick="editQueryResult()" class="btn-outline-black w-full">
                        <i class="fa fa-refresh mr-2"></i>
                        <span data-i18n="resubmit">重新提交</span>
                    </button>
                `;
            } else if (recordId === 'exited') {
                // 已退出，无按钮
                statusClass = 'bg-gray-100 text-gray-600';
                statusText = translations[currentLang].exited || 'Exited';
                buttonHTML = '';
            } else if (recordId === 'two_authorizing') {
                // 双记录中的授权中，有编辑按钮
                statusClass = 'bg-warning/10 text-warning';
                statusText = translations[currentLang].authorizing || 'Authorizing';
                buttonHTML = `
                    <button onclick="editQueryResult()" class="btn-outline-black w-full">
                        <i class="fa fa-pencil mr-2"></i>
                        <span data-i18n="edit_info">修改信息</span>
                    </button>
                `;
            } else if (recordId === 'two_authorized') {
                // 双记录中的已授权，无编辑按钮
                statusClass = 'bg-success/10 text-success';
                statusText = translations[currentLang].authorized || 'Authorized';
                buttonHTML = '';
            } else {
                // 默认情况
                statusClass = 'bg-success/10 text-success';
                statusText = translations[currentLang].authorized || 'Authorized';
                buttonHTML = `
                    <button onclick="editQueryResult()" class="btn-outline-black w-full">
                        <i class="fa fa-pencil mr-2"></i>
                        <span data-i18n="edit_info">修改信息</span>
                    </button>
                `;
            }
            
            // 生成仿真签名
            function createQueryMockSignature(name) {
                const canvas = document.createElement('canvas');
                canvas.width = 250;
                canvas.height = 80;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000000';
                ctx.font = '20px cursive';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(name, canvas.width/2, canvas.height/2);
                return canvas.toDataURL('image/png');
            }
            
            const customerSignatureUrl = createQueryMockSignature(mockCustomerName);
            const installerSignatureUrl = createQueryMockSignature(mockInstallerName);
            
            // 填充详情页面内容
            detailContent.innerHTML = `
                <!-- 授权状态 -->
                <div class="text-center py-4 mb-4">
                    <div class="flex justify-center items-center gap-2">
                        <span class="text-sm text-secondary" data-i18n="auth_status">Authorization Status</span>
                        <span class="font-medium text-sm px-3 py-1 rounded-full ${statusClass}">${statusText}</span>
                    </div>
                </div>
                
                <!-- 客户详情 -->
                <div class="card-apple p-4 space-y-4 mb-4">
                    <h3 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                        <span data-i18n="customer_details">客户详情</span>
                    </h3>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="customer_name">客户姓名</span>
                        <span class="font-medium text-sm">${mockCustomerName}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="mobile">手机号</span>
                        <span class="font-medium text-sm">${mockMobile}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="email">邮箱</span>
                        <span class="font-medium text-sm">${mockEmail}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="nmi">NMI</span>
                        <span class="font-medium text-sm">${mockNMI}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="supply_address">供电地址</span>
                        <span class="font-medium text-sm text-right max-w-[60%]">${mockAddress}</span>
                    </div>
                </div>

                <!-- 系统详情 -->
                <div class="card-apple p-4 space-y-4 mb-4">
                    <h3 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                        <span data-i18n="system_details">系统详情</span>
                    </h3>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="battery_brand">品牌</span>
                        <span class="font-medium text-sm">${mockBrand}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="account">账号</span>
                        <span class="font-medium text-sm">${mockAccount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="inverter_sn">逆变器SN</span>
                        <span class="font-medium text-sm">${mockInverterSN}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="battery_sn">电池SN</span>
                        <span class="font-medium text-sm">${mockBatterySN}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="battery_capacity">电池容量</span>
                        <span class="font-medium text-sm">${mockCapacity}</span>
                    </div>
                </div>

                <!-- 客户签名信息 -->
                <div class="card-apple p-4 space-y-4 mb-4">
                    <h3 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                        <span data-i18n="customer_signature_info">客户签名信息</span>
                    </h3>
                    <div class="flex justify-between">
                        <span class="text-tertiary text-sm" data-i18n="signature_date">签名日期</span>
                        <span class="font-medium text-sm">2025-09-05</span>
                    </div>
                    <div>
                        <span class="text-tertiary text-sm block mb-2" data-i18n="customer_signature_label">客户签名</span>
                        <div class="border border-border rounded-xl p-2 bg-light min-h-[60px] flex items-center justify-center">
                            <img src="${customerSignatureUrl}" alt="客户签名" class="w-full h-auto max-h-20 object-contain" />
                        </div>
                    </div>
                </div>

                
                <div class="mt-6">
                    ${buttonHTML}
                </div>
            `;
            
            // 应用当前语言翻译
            if (typeof changeLanguage === 'function' && window.currentLang) {
                setTimeout(() => changeLanguage(window.currentLang), 50);
            }
        }
        
        
        function backToForm() {
            const formPage = document.getElementById('form-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            if (formPage) formPage.classList.remove('hidden');
            if (successPage) successPage.classList.add('hidden');
            if (submitBtnContainer) submitBtnContainer.classList.remove('hidden');
        }
        
        function toggleLanguage() {
            const langModal = document.getElementById('lang-modal');
            if (langModal) {
                langModal.classList.remove('hidden');
            }
        }
        
        function closeLangModal() {
            const langModal = document.getElementById('lang-modal');
            if (langModal) {
                langModal.classList.add('hidden');
            }
        }
        
        function selectLanguage(lang) {
            console.log('切换语言到:', lang);
            
            // 设置当前语言
            window.currentLang = lang;
            
            // 直接调用changeLanguage函数进行全局翻译
            if (typeof window.changeLanguage === 'function') {
                window.changeLanguage(lang);
            } else {
                // 如果主函数不存在，使用紧急备用翻译
                emergencyChangeLanguage(lang);
            }
            
            closeLangModal();
        }
        
        // 紧急备用翻译函数
        function emergencyChangeLanguage(lang) {
            console.log('使用紧急翻译功能:', lang);
            
            // 更新语言显示
            const currentLangSpan = document.getElementById('current-lang');
            if (currentLangSpan) {
                currentLangSpan.textContent = lang === 'zh' ? '中文' : 'English';
            }
            
            // 基础翻译映射
            const translations = {
                'zh': {
                    'company_info': 'CovaU有限公司 (ABN 54 090 117 730)',
                    'enquiries_label': '咨询电话：',
                    'form_title': 'VPP平台客户授权同意书',
                    'dear_customer': '尊敬的客户，',
                    'welcome_message': '感谢您选择CovaU作为您的虚拟电厂(VPP)服务提供商。',
                    'form_description': '此授权表单旨在获得您的同意和授权，允许CovaU在我们的VPP运营过程中为您提供服务，以及您向我们提供的服务，包括授予CovaU访问和控制您的电池系统的权限。',
                    'vpp_definition': '是指CovaU的"VPP平台"系统，该系统将在VPP事件期间与您的合格电池系统进行通信、访问和控制，CovaU可能会不时更新该系统。',
                    'form_notice': '在签署表单之前，请确保您的所有详细信息和系统详细信息都是正确的。',
                    'query_btn': '查询',
                    'customer_authorization': '客户授权',
                    'installer_information': '安装人员信息',
                    'installer_info_title': '安装人员信息',
                    'installer_info_note': '注：仅适用于客户要求电池安装的情况',
                    'customer_details': '客户详情',
                    'system_details': '系统详情',
                    'customer_signature_info': '客户签名信息',
                    'customer_name': '客户姓名',
                    'mobile': '手机号',
                    'email': '邮箱',
                    'next_step': '下一步',
                    'prev_step': '上一步',
                    'submit_form': '提交',
                    'edit_info': '修改信息',
                    'installer_name': '安装人员姓名',
                    'installer_company': '安装公司',
                    'installer_license': '安装人员执照号',
                    'installer_signature_date': '安装人员签名日期',
                    'installer_signature_label': '安装人员签名',
                    'installer_signature_hint': '请安装人员在上方区域签名',
                    'clear_signature': '清除',
                    'nmi': 'NMI',
                    'supply_address': '供电地址',
                    'battery_brand': '品牌',
                    'account': '用户名',
                    'inverter_sn': '逆变器SN',
                    'battery_capacity': '电池容量',
                    'signature_date': '签名日期',
                    'customer_signature_label': '客户签名',
                    'signature_label': '签名确认'
                },
                'en': {
                    'company_info': 'CovaU Pty Ltd (ABN 54 090 117 730)',
                    'enquiries_label': 'Enquiries: ',
                    'form_title': 'Customer Authorisation and Consent for VPP Platform',
                    'dear_customer': 'Dear Customer,',
                    'welcome_message': 'Thank you for choosing CovaU as your Virtual Power Plant (VPP) provider.',
                    'form_description': 'This Authorisation Form is intended to grant your consent and authorisation to CovaU, allowing us to perform the services we provide to you as part of the operation of our VPP, as well as the services you provide to us, including granting CovaU access to and control over your Battery.',
                    'vpp_definition': 'means CovaU "VPP Platform" system which will communicate with, access and control your Eligible Battery System during VPP Events, as may be updated from time to time by CovaU.',
                    'form_notice': 'Before signing the Form, please make sure all your details and system details are correct.',
                    'query_btn': 'Query',
                    'customer_authorization': 'Customer Authorization',
                    'installer_information': 'Installer Information',
                    'installer_info_title': 'Installer Information',
                    'installer_info_note': 'Note: Only applicable when customers have requested battery installation',
                    'customer_details': 'Customer Details',
                    'system_details': 'System Details',
                    'customer_signature_info': 'Customer Signature Information',
                    'customer_name': 'Customer Name',
                    'mobile': 'Mobile',
                    'email': 'Email',
                    'next_step': 'Next Step',
                    'prev_step': 'Previous Step',
                    'submit_form': 'Submit',
                    'edit_info': 'Edit Information',
                    'installer_name': 'Installer Name',
                    'installer_company': 'Company',
                    'installer_license': 'License Number',
                    'installer_signature_date': 'Installer Signature Date',
                    'installer_signature_label': 'Installer Signature',
                    'installer_signature_hint': 'Please sign above',
                    'clear_signature': 'Clear',
                    'nmi': 'NMI',
                    'supply_address': 'Supply Address',
                    'battery_brand': 'Brand',
                    'account': 'User Name',
                    'inverter_sn': 'Inverter SN',
                    'battery_capacity': 'Battery Capacity',
                    'signature_date': 'Signature Date',
                    'customer_signature_label': 'Customer Signature',
                    'signature_label': 'Signature'
                }
            };
            
            // 应用翻译
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            // 更新placeholder
            const placeholders = {
                'customerName': lang === 'zh' ? '请输入客户姓名' : 'Enter customer name',
                'mobile': lang === 'zh' ? '请输入手机号码' : 'Enter mobile number',
                'email': lang === 'zh' ? '请输入电子邮箱地址' : 'Enter email address',
                'nmi': lang === 'zh' ? 'Enter NMI number' : 'Enter NMI number',
                'supplyAddress': lang === 'zh' ? '请输入供电地址' : 'Enter supply address',
                'batteryAccount': lang === 'zh' ? '请输入用户名' : 'Enter user name',
                'inverterSN': lang === 'zh' ? '请输入逆变器序列号' : 'Enter inverter serial number',
                'batteryCapacity': lang === 'zh' ? '请输入电池容量 (如: 13.5kWh)' : 'Enter battery capacity (e.g.: 13.5kWh)',
                'installerName': lang === 'zh' ? '请输入安装人员姓名' : 'Enter installer name',
                'installerCompany': lang === 'zh' ? '请输入安装公司' : 'Enter company name',
                'installerLicense': lang === 'zh' ? '请输入执照号' : 'Enter license number',
                'email-input': lang === 'zh' ? '请输入邮箱地址' : 'Enter email address',
                'mobile-input': lang === 'zh' ? '请输入手机号码' : 'Enter mobile number',
                'addressDetails': lang === 'zh' ? '补充地址信息（单元号、楼宇名称等）' : 'Additional address info (unit number, building name, etc.)',
                'batteryCapacityPlaceholder': lang === 'zh' ? '例如: 100Ah' : 'e.g.: 100Ah'
            };
            
            Object.keys(placeholders).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.placeholder = placeholders[id];
            });
        }
        
        // 确保函数全局可访问
        window.testClick = testClick;
        window.openQueryPage = openQueryPage;
        window.closeQueryPage = closeQueryPage;
        window.editQueryResult = editQueryResult;
        window.goBackToRecordList = goBackToRecordList;
        window.backToQuery = backToQuery;
        window.performQuery = performQuery;
        window.showRecordDetail = showRecordDetail;
        window.submitForm = submitForm;
        window.backToForm = backToForm;
        window.editInfo = editInfo;
        window.toggleLanguage = toggleLanguage;
        window.closeLangModal = closeLangModal;
        window.selectLanguage = selectLanguage;
        window.emergencyChangeLanguage = emergencyChangeLanguage;
        
        
        // 页面加载后设置初始语言为英文
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面DOM加载完成，开始初始化英文模式');
            
            // 立即设置语言
            window.currentLang = 'en';
            
            // 使用主翻译函数
            if (typeof changeLanguage === 'function') {
                changeLanguage('en');
            } else {
                emergencyChangeLanguage('en');
            }
            
            // 延时确保DOM完全准备好后再次执行
            setTimeout(() => {
                // 再次设置语言确保翻译
                if (typeof changeLanguage === 'function') {
                    changeLanguage('en');
                } else {
                    emergencyChangeLanguage('en');
                }
            }, 100);
            
            // 额外延时确保所有内容都翻译
            setTimeout(() => {
                if (typeof changeLanguage === 'function') {
                    changeLanguage('en');
                } else {
                    emergencyChangeLanguage('en');
                }
            }, 300);
        });
        
        // 立即执行初始翻译（防止DOM还没加载完成）
        setTimeout(() => {
            console.log('执行立即英文翻译');
            window.currentLang = 'en';
            if (typeof changeLanguage === 'function') {
                changeLanguage('en');
            } else {
                emergencyChangeLanguage('en');
            }
        }, 50);
        
        // 最终确保翻译
        setTimeout(() => {
            window.currentLang = 'en';
            if (typeof changeLanguage === 'function') {
                changeLanguage('en');
            } else {
                emergencyChangeLanguage('en');
            }
        }, 500);
        
        console.log('紧急修复脚本已加载');
        
        // 立即执行英文翻译 - 最高优先级
        window.currentLang = 'en';
        if (typeof changeLanguage === 'function') {
            changeLanguage('en');
        } else {
            emergencyChangeLanguage('en');
        }
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

    <!-- Tailwind 配置 - 苹果风格 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0071e3',
                        secondary: '#1d1d1f',
                        tertiary: '#86868b',
                        light: '#f5f5f7',
                        success: '#34c759',
                        warning: '#ff9500',
                        danger: '#ff3b30',
                        border: '#d2d2d7',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'apple': '0 2px 10px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.03)',
                        'apple-hover': '0 5px 15px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05)',
                    }
                },
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-all duration-200;
            }
            .btn-apple {
                @apply bg-primary text-white font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-outline {
                @apply border border-primary text-primary font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-outline-black {
                @apply border border-black text-black font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-black {
                @apply bg-black text-white font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .input-apple {
                @apply w-full px-4 py-4 bg-light border border-transparent rounded-xl transition-all duration-200 text-base;
                &:focus {
                    @apply ring-2 ring-primary border-primary text-black outline-none bg-white;
                }
            }
            .label-apple {
                @apply block text-sm font-semibold text-secondary mb-2;
            }
            .card-apple {
                @apply bg-white rounded-2xl overflow-hidden transition-all duration-300;
            }
        }
    </style>

    <style>
        /* 全局样式 */
        html, body {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: #f5f5f7;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        /* 防止iOS弹性滚动 */
        .no-bounce {
            overscroll-behavior: contain;
        }
        
        /* 签名板样式 */
        .signature-pad {
            border: 2px dashed #d2d2d7;
            border-radius: 1rem;
            background-color: white;
            touch-action: none;
        }
        .signature-pad:focus {
            outline: none;
            border-color: #0071e3;
        }
        
        /* 底部固定按钮容器 */
        .fixed-bottom-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,1) 85%, rgba(255,255,255,0));
            z-index: 40;
        }
        
        /* 底部安全区域 */
        .bottom-safe-area {
            height: env(safe-area-inset-bottom);
            background: white;
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 触摸反馈 */
        .touchable {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        .touchable:active {
            opacity: 0.7;
        }
        
        /* 模态框动画 */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .modal-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        /* 状态消息动画 */
        @keyframes fadeSlideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .status-message {
            animation: fadeSlideDown 0.3s ease-out;
        }
        
        /* 隐藏滚动条但保持滚动功能 */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* 输入框聚焦时防止键盘遮挡 */
        input:focus, textarea:focus, select:focus {
            font-size: 16px !important;
        }
        
        /* 全屏模态框背景 */
        .modal-backdrop {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* 弹性布局辅助类 */
        .flex-2 {
            flex: 2;
        }
        
        /* 提示图标样式 */
        .hint-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .hint-icon:hover {
            opacity: 1;
        }
        
        /* 图片预览模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal-container {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .modal-close-btn:hover {
            background-color: #F3F4F6;
        }
        
        .modal-body {
            padding: 20px;
            text-align: center;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 640px) {
            .modal-container {
                margin: 16px;
                max-width: calc(100vw - 32px);
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-image {
                max-height: 75vh;
            }
        }
        
        /* 语言切换样式 */
        .lang-text {
            display: none;
        }
        
        body[data-lang="en"] .lang-text[data-lang="en"],
        body[data-lang="zh"] .lang-text[data-lang="zh"] {
            display: inline;
        }
        
        /* 只读输入框样式 */
        .input-readonly {
            background-color: #f5f5f7 !important;
            cursor: not-allowed;
            color: #86868b !important;
            pointer-events: none;
        }
        
        .input-readonly:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: #d2d2d7 !important;
        }
        
        .input-readonly:hover {
            border-color: #d2d2d7 !important;
        }
    </style>
</head>
<body class="font-sans text-secondary no-bounce" data-lang="en">
    <!-- 顶部固定导航栏 -->
    <header class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md z-50 safe-top border-b border-border">
        <div class="flex justify-between items-center px-4 py-3">
            <img src="新logo.png" alt="Logo" class="h-7 max-w-[120px] object-contain">
            <div class="flex items-center gap-2">
                <!-- 查询按钮 -->
                <button id="query-btn" class="touchable px-3 py-1.5 rounded-full bg-black text-white text-sm font-medium" onclick="openQueryPage()">
                    <i class="fa fa-search mr-1"></i>
                    <span data-i18n="query_btn">Query</span>
                </button>
                <!-- 语言切换按钮 -->
                <button id="lang-toggle-btn" class="touchable px-3 py-1.5 rounded-full bg-light text-sm font-medium" onclick="toggleLanguage()">
                    <span id="current-lang">English</span>
                </button>
            </div>
        </div>
    </header>


    <!-- 主内容区域 -->
    <main class="pt-20 pb-24" id="main-content">
        <!-- 状态消息 -->
        <div id="status-message" class="hidden fixed top-40 left-4 right-4 p-3 rounded-xl status-message z-50 safe-top"></div>

        <!-- 表单页面（默认显示） -->
        <div id="form-page" class="px-4 py-4">
            <!-- 公司信息与VPP授权说明合并卡片 -->
            <div class="card-apple p-4 mb-6">
                <!-- 公司信息部分 -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <img src="新logo.png" alt="CovaU Logo" class="h-12 w-auto">
                    </div>
                    <div class="text-right text-xs text-secondary">
                        <p class="mb-1">
                            <span class="font-medium" data-i18n="company_info">CovaU Pty Ltd (ABN 54 090 117 730)</span>
                        </p>
                        <p>
                            <span data-i18n="enquiries_label">Enquiries: </span>
                            <span class="font-medium">1300 689 866</span>
                        </p>
                    </div>
                </div>
                
                <!-- 动态标题和描述区域 -->
                <div id="step-header">
                    <h1 class="text-xl font-bold text-secondary mb-4 text-center" data-i18n="form_title">
                        Customer Authorisation and Consent for VPP Platform
                    </h1>
                    
                    <div class="text-sm text-secondary space-y-2">
                        <p><strong data-i18n="dear_customer">Dear Customer,</strong></p>
                        <p data-i18n="welcome_message">Thank you for choosing CovaU as your Virtual Power Plant (VPP) provider.</p>
                        <p data-i18n="form_description">This Authorisation Form is intended to grant your consent and authorisation to CovaU, allowing us to perform the services we provide to you as part of the operation of our VPP, as well as the services you provide to us, including granting CovaU access to and control over your Battery.</p>
                        <p class="bg-light p-3 rounded-lg">
                            <strong>VPP Platform</strong> <span data-i18n="vpp_definition">means CovaU "VPP Platform" system which will communicate with, access and control your Eligible Battery System during VPP Events, as may be updated from time to time by CovaU.</span>
                        </p>
                        <p class="text-warning font-medium">
                            <i class="fa fa-info-circle mr-1"></i>
                            <span data-i18n="form_notice">Before signing the Form, please make sure all your details and system details are correct.</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <form id="vpp-form" class="space-y-4">
                <!-- 第一步：客户授权 -->
                <div id="step1-content">
                    <!-- 客户详情 -->
                    <div class="card-apple p-4 space-y-6 mb-4">
                        <h2 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                            <span data-i18n="customer_details">Customer Details</span>
                        </h2>
                        
                        <!-- 客户姓名 -->
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-secondary mb-2" data-i18n="customer_name">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" 
                                   placeholder="Enter customer name" 
                                   class="input-apple">
                        </div>

                        <!-- 手机号 -->
                        <div>
                            <label for="mobile" class="block text-sm font-medium text-secondary mb-2" data-i18n="mobile">Mobile</label>
                            <input type="tel" id="mobile" name="mobile" 
                                   placeholder="Enter mobile number" 
                                   class="input-apple">
                        </div>

                        <!-- 邮箱 -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-secondary mb-2" data-i18n="email">Email</label>
                            <input type="email" id="email" name="email" 
                                   placeholder="Enter email address" 
                                   class="input-apple">
                        </div>

                        <!-- NMI -->
                        <div>
                            <label for="nmi" class="block text-sm font-medium text-secondary mb-2" data-i18n="nmi">NMI</label>
                            <input type="text" id="nmi" name="nmi" 
                                   placeholder="Enter NMI number" 
                                   class="input-apple">
                        </div>

                        <!-- 供电地址 -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2" data-i18n="supply_address">Supply Address</label>
                            <div class="space-y-3">
                                <div class="relative">
                                    <input type="text" id="supplyAddress" name="supplyAddress" 
                                           placeholder="Enter supply address" 
                                           class="input-apple cursor-pointer" readonly>
                                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-2">
                                        <button type="button" id="refresh-location-btn" class="touchable p-2" title="Refresh location">
                                            <i class="fa fa-location-arrow text-primary"></i>
                                        </button>
                                        <button type="button" id="select-region-btn" class="touchable p-2" title="Select region">
                                            <i class="fa fa-map-marker text-primary"></i>
                                        </button>
                                    </div>
                                </div>
                                <textarea id="addressDetails" name="addressDetails" rows="2" 
                                          placeholder="Additional address info (unit number, building name, etc.)"
                                          class="input-apple resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 系统详情 -->
                    <div class="card-apple p-4 space-y-6 mb-4">
                        <h2 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                            <span data-i18n="system_details">System Details</span>
                        </h2>

                        <!-- 电池品牌 -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2" data-i18n="battery_brand">Brand</label>
                            <button type="button" id="brand-select-btn" class="w-full px-3 py-3 bg-light rounded-xl text-left flex justify-between items-center">
                                <span id="brand-display" class="text-base text-tertiary" data-i18n="please_select_brand">Please select brand</span>
                                <i class="fa fa-chevron-down text-tertiary"></i>
                            </button>
                            <input type="hidden" id="batteryBrand" name="batteryBrand" value="">
                        </div>

                        <!-- 账号 -->
                        <div>
                            <label for="batteryAccount" class="block text-sm font-medium text-secondary mb-2" data-i18n="account">
                                <span class="lang-text" data-lang="en">User Name</span>
                                <span class="lang-text" data-lang="zh">用户名</span>
                                <button type="button" class="hint-icon ml-2" onclick="openHintModal('account')" title="查看示例图片">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="12" cy="12" r="10" stroke="#6B7280" stroke-width="2"/>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="17" r="1" fill="#6B7280"/>
                                    </svg>
                                </button>
                            </label>
                            <input type="text" id="batteryAccount" name="batteryAccount" 
                                   placeholder="Enter user name" 
                                   class="input-apple">
                        </div>

                        <!-- 逆变器SN -->
                        <div>
                            <label for="inverterSN" class="block text-sm font-medium text-secondary mb-2" data-i18n="inverter_sn">
                                <span class="lang-text" data-lang="en">Inverter SN</span>
                                <span class="lang-text" data-lang="zh">逆变器SN</span>
                                <button type="button" class="hint-icon ml-2" onclick="openHintModal('inverterSN')" title="查看示例图片">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="12" cy="12" r="10" stroke="#6B7280" stroke-width="2"/>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="17" r="1" fill="#6B7280"/>
                                    </svg>
                                </button>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="inverterSN" name="inverterSN" 
                                       placeholder="Enter inverter serial number" 
                                       class="flex-1 input-apple">
                                <button type="button" id="scan-inverter-btn" class="touchable px-4 py-3 bg-light rounded-xl">
                                    <i class="fa fa-qrcode text-primary text-xl"></i>
                                </button>
                            </div>
                        </div>


                        <!-- 电池容量 -->
                        <div>
                            <label for="batteryCapacity" class="block text-sm font-medium text-secondary mb-2" data-i18n="battery_capacity">
                                <span class="lang-text" data-lang="en">Battery Capacity (kWh)</span>
                                <span class="lang-text" data-lang="zh">电池容量 (kWh)</span>
                                <button type="button" class="hint-icon ml-2" onclick="openHintModal('batteryCapacity')" title="查看示例图片">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="12" cy="12" r="10" stroke="#6B7280" stroke-width="2"/>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="17" r="1" fill="#6B7280"/>
                                    </svg>
                                </button>
                            </label>
                            <input type="text" id="batteryCapacity" name="batteryCapacity" 
                                   placeholder="e.g.: 13.5kWh" 
                                   class="input-apple">
                        </div>
                    </div>

                    <!-- 客户签名 -->
                    <div class="card-apple p-4 space-y-6">
                        <h2 class="text-lg font-semibold text-secondary border-b pb-2 border-gray-200">
                            <span data-i18n="customer_signature">Customer Signature</span>
                        </h2>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-medium text-secondary" data-i18n="signature_label">Signature Confirmation</label>
                                <button type="button" id="clear-signature-btn" class="touchable text-sm text-danger">
                                    <span data-i18n="clear_signature">Clear</span>
                                </button>
                            </div>
                            <canvas id="signature-pad" class="signature-pad w-full h-40"></canvas>
                            <p class="text-xs text-tertiary mt-2 text-center" data-i18n="signature_hint">Please sign in the area above</p>
                        </div>

                        <!-- 签名日期 -->
                        <div>
                            <label for="signatureDate" class="block text-sm font-medium text-secondary mb-2" data-i18n="signature_date">Signature Date</label>
                            <input type="date" id="signatureDate" name="signatureDate" class="input-apple input-readonly" readonly>
                        </div>
                    </div>
                </div>


            </form>
        </div>

        <!-- 查询页面（初始隐藏） -->
        <div id="query-page" class="hidden px-4 py-4">
            
            <div class="space-y-4">
                <!-- 查询条件区域 -->
                <div>
                    <!-- 返回图标 -->
                    <div class="flex justify-start mb-3">
                        <button id="query-form-back-btn" class="touchable flex items-center gap-1.5 -ml-1" onclick="backToForm()">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                            <span class="text-blue-500 text-base">Back</span>
                        </button>
                    </div>
                    <!-- 查询条件输入框 -->
                    <div class="card-apple p-4 space-y-6">
                        <!-- 邮箱输入框 -->
                        <div>
                            <label for="email-input" class="block text-sm font-medium text-secondary mb-2" data-i18n="email">Email</label>
                            <input type="email" id="email-input" 
                                   placeholder="Enter email address" 
                                   class="w-full px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                        </div>
                        
                        <!-- 手机号输入框 -->
                        <div>
                            <label for="mobile-input" class="block text-sm font-medium text-secondary mb-2" data-i18n="mobile">Mobile</label>
                            <input type="tel" id="mobile-input" 
                                   placeholder="Enter mobile number" 
                                   class="w-full px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                        </div>
                    </div>
                </div>
                
                <!-- 查询按钮 -->
                <button id="do-query-btn" class="btn-black w-full flex justify-center items-center gap-2" onclick="performQuery()">
                    <i class="fa fa-search"></i>
                    <span data-i18n="do_query">Query</span>
                </button>
            </div>
            
            <!-- 查询结果区域 -->
            <div id="query-result" class="hidden mt-6">
                <div class="card-apple p-4">
                    <div id="query-result-content" class="space-y-3 text-sm"></div>
                </div>
            </div>
            
            <!-- 无数据提示 -->
            <div id="no-data-message" class="hidden mt-6 card-apple p-4 bg-danger/5 border border-danger/20">
                <div class="flex items-center gap-3">
                    <i class="fa fa-info-circle text-danger text-xl"></i>
                    <div>
                        <p class="font-medium text-danger" data-i18n="query_failed">Query Failed</p>
                        <p class="text-xs text-tertiary mt-0.5" data-i18n="no_data">No account information found</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查询详情页面（初始隐藏） -->
        <div id="detail-page" class="hidden px-4 py-4" style="padding-top: 90px;">
            <!-- 顶部导航区域 -->
            <div class="flex items-center justify-between mb-6">
                <button id="detail-back-btn" class="touchable flex items-center gap-1.5" onclick="backToQuery()">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="text-blue-500 text-base">Back</span>
                </button>
                <h1 class="text-xl font-bold">Authorization Details</h1>
                <div class="w-12"></div> <!-- 占位元素保持标题居中 -->
            </div>
            
            <div id="detail-content" class="space-y-4">
                <!-- 详情内容将在这里动态生成 -->
            </div>
        </div>

        <!-- 提交成功页面（初始隐藏） -->
        <div id="success-page" class="hidden px-4 py-4">
            <!-- 顶部导航 -->
            <div class="flex items-center mb-6">
                <button id="back-btn" class="mr-4 p-2 -ml-2" onclick="editInfo()">
                    <i class="fa fa-chevron-left text-xl text-secondary"></i>
                </button>
                <h1 class="text-xl font-bold">
                    <span class="lang-text" data-lang="en">Authorization Details</span>
                    <span class="lang-text" data-lang="zh">授权详情</span>
                </h1>
            </div>

            <!-- 授权状态 -->
            <div class="bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 text-sm">
                        <span class="lang-text" data-lang="en">Authorization Status</span>
                        <span class="lang-text" data-lang="zh">授权状态</span>
                    </span>
                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                        <span class="lang-text" data-lang="en">Authorizing</span>
                        <span class="lang-text" data-lang="zh">授权中</span>
                    </span>
                </div>
            </div>

            <!-- 客户详情 -->
            <div class="bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-100">
                <h3 class="font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
                    <span class="lang-text" data-lang="en">Customer Details</span>
                    <span class="lang-text" data-lang="zh">客户详情</span>
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Customer Name</span>
                            <span class="lang-text" data-lang="zh">客户姓名</span>
                        </span>
                        <span id="display-customer-name" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Mobile</span>
                            <span class="lang-text" data-lang="zh">手机号</span>
                        </span>
                        <span id="display-mobile" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Email</span>
                            <span class="lang-text" data-lang="zh">邮箱</span>
                        </span>
                        <span id="display-email" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">NMI</span>
                        <span id="display-nmi" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Supply Address</span>
                            <span class="lang-text" data-lang="zh">供电地址</span>
                        </span>
                        <span id="display-supply-address" class="font-medium text-sm text-gray-900 text-right max-w-[60%]"></span>
                    </div>
                </div>
            </div>

            <!-- 系统详情 -->
            <div class="bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-100">
                <h3 class="font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
                    <span class="lang-text" data-lang="en">System Details</span>
                    <span class="lang-text" data-lang="zh">系统详情</span>
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Brand</span>
                            <span class="lang-text" data-lang="zh">品牌</span>
                        </span>
                        <span id="display-brand" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">User Name</span>
                            <span class="lang-text" data-lang="zh">账号</span>
                        </span>
                        <span id="display-account" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Inverter SN</span>
                            <span class="lang-text" data-lang="zh">逆变器SN</span>
                        </span>
                        <span id="display-inverter-sn" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Battery SN</span>
                            <span class="lang-text" data-lang="zh">电池SN</span>
                        </span>
                        <span id="display-battery-sn" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Battery Capacity</span>
                            <span class="lang-text" data-lang="zh">电池容量</span>
                        </span>
                        <span id="display-battery-capacity" class="font-medium text-sm text-gray-900"></span>
                    </div>
                </div>
            </div>

            <!-- 客户签名信息 -->
            <div class="bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-100">
                <h3 class="font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
                    <span class="lang-text" data-lang="en">Customer Signature Information</span>
                    <span class="lang-text" data-lang="zh">客户签名信息</span>
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 text-sm">
                            <span class="lang-text" data-lang="en">Signature Date</span>
                            <span class="lang-text" data-lang="zh">签名日期</span>
                        </span>
                        <span id="display-signature-date" class="font-medium text-sm text-gray-900"></span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-sm block mb-2">
                            <span class="lang-text" data-lang="en">Customer Signature</span>
                            <span class="lang-text" data-lang="zh">客户签名</span>
                        </span>
                        <div id="display-signature-container" class="border border-gray-200 rounded-lg p-3 bg-gray-50 min-h-[80px] flex items-center justify-center">
                            <span class="text-gray-500 text-sm">
                                <span class="lang-text" data-lang="en">Customer Signature</span>
                                <span class="lang-text" data-lang="zh">客户签名</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- 底部按钮 -->
            <div class="pb-6">
                <button id="edit-btn" class="border border-black text-black w-full py-3 rounded-lg font-medium" onclick="editInfo()">
                    <i class="fa fa-pencil mr-2"></i>
                    <span class="lang-text" data-lang="en">Edit Information</span>
                    <span class="lang-text" data-lang="zh">修改信息</span>
                </button>
            </div>
        </div>

        <!-- 最终提交成功页面（初始隐藏） -->
        <div id="final-success-page" class="hidden px-4 py-4">
            <div class="text-center py-12 mt-8">
                <div class="w-24 h-24 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fa fa-check text-success text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-3 text-success" data-i18n="submit_success">Submit Success</h2>
                <p class="text-tertiary text-base mb-8" data-i18n="success_message">VPP Authorization has been successfully submitted</p>
                
                <div class="space-y-4">
                    <button id="view-details-btn" class="btn-outline w-full" onclick="viewSubmittedDetails()">
                        <i class="fa fa-file-text mr-2"></i>
                        <span data-i18n="view_details">View Details</span>
                    </button>
                    <button id="new-submission-btn" class="btn-black w-full" onclick="startNewSubmission()">
                        <i class="fa fa-plus mr-2"></i>
                        <span data-i18n="new_submission">New Submission</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部固定按钮 -->
    <div id="submit-btn-container" class="fixed-bottom-btn p-4">
        <button type="button" id="submit-btn" class="btn-black w-full flex justify-center items-center gap-2" onclick="submitForm()">
            <i class="fa fa-paper-plane"></i>
            <span data-i18n="submit_form">Submit</span>
        </button>
        <div class="bottom-safe-area"></div>
    </div>

    <!-- 地址选择底部弹出框 -->
    <div id="address-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 85vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 模态框头部 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="select_address_title">Select Address</h3>
                    <button id="close-address-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 地址列表 -->
            <div class="overflow-y-auto hide-scrollbar" style="max-height: calc(85vh - 200px);">
                <!-- 搜索框 -->
                <div class="px-4 py-3 sticky top-0 bg-white border-b border-border">
                    <div class="relative">
                        <input type="text" id="address-search" 
                               placeholder="Search address" 
                               class="w-full pl-10 pr-4 py-3 bg-light rounded-xl">
                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary"></i>
                    </div>
                </div>
                
                <!-- 热门地址 -->
                <div class="px-4 py-3">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="popular_addresses">Popular Addresses</p>
                    <div class="space-y-1" id="address-list-container">
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="Sydney, NSW, Australia">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">Sydney</p>
                                    <p class="text-xs text-tertiary">NSW, Australia</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="Melbourne, VIC, Australia">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">Melbourne</p>
                                    <p class="text-xs text-tertiary">VIC, Australia</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="Brisbane, QLD, Australia">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">Brisbane</p>
                                    <p class="text-xs text-tertiary">QLD, Australia</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="Perth, WA, Australia">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">Perth</p>
                                    <p class="text-xs text-tertiary">WA, Australia</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="Adelaide, SA, Australia">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">Adelaide</p>
                                    <p class="text-xs text-tertiary">SA, Australia</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- 手动输入 -->
                <div class="px-4 py-3 border-t border-border bg-white">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="manual_input">Manual Address Input</p>
                    <div class="flex gap-2">
                        <input type="text" id="manual-address-input" 
                               placeholder="Enter detailed address" 
                               class="flex-1 px-4 py-3 bg-light rounded-xl">
                        <button id="confirm-manual-address" class="btn-apple px-6">
                            <span data-i18n="confirm">Confirm</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐私政策模态框 -->
    <div id="privacy-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 85vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 模态框头部 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="privacy_title">Privacy Policy</h3>
                    <button id="close-privacy-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="px-4 py-4 overflow-y-auto hide-scrollbar" style="max-height: calc(85vh - 140px);">
                <div class="text-sm text-tertiary space-y-4">
                    <p>This privacy policy describes how we collect, use, store and protect the information you provide.</p>
                    <p>The information we collect is only used for device management and service provision purposes and will not be shared with third parties.</p>
                    <p>You have the right to access, correct or delete your personal information. If you have any questions, please contact our customer service team.</p>
                    <p>By submitting this form, you confirm that you have read and agreed to our privacy policy.</p>
                </div>
            </div>
            
            <!-- 底部按钮 -->
            <div class="px-4 py-3 border-t border-border bg-white">
                <button id="privacy-read-btn" class="btn-black w-full">
                    <span data-i18n="privacy_read_btn">I Have Read</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 品牌选择模态框 -->
    <div id="brand-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 60vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 标题 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="select_brand_title">Select Brand</h3>
                    <button id="close-brand-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 品牌列表 -->
            <div class="overflow-y-auto" style="max-height: calc(60vh - 120px);">
                <div class="py-2">
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="FOX ESS" onclick="selectBrand('FOX ESS')">
                        <span class="text-base">FOX ESS</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                    
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="weiheng" onclick="selectBrand('weiheng')">
                        <span class="text-base">weiheng</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                    
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="ipotisedge" onclick="selectBrand('ipotisedge')">
                        <span class="text-base">ipotisedge</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                </div>
            </div>
            
            <!-- 底部安全区 -->
            <div class="safe-bottom bg-white"></div>
        </div>
    </div>
    
    <!-- 语言选择模态框 -->
    <div id="lang-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop" onclick="closeLangModal()">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" onclick="event.stopPropagation()">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 标题 -->
            <div class="px-4 pb-3 border-b border-border">
                <h3 class="text-lg font-bold">选择语言</h3>
            </div>
            
            <!-- 语言选项 -->
            <div class="py-2">
                <button class="lang-option touchable w-full text-left px-4 py-4 flex justify-between items-center" data-lang="zh" onclick="selectLanguage('zh')">
                    <span class="text-base">中文</span>
                    <i class="fa fa-check text-primary hidden" id="lang-check-zh"></i>
                </button>
                <button class="lang-option touchable w-full text-left px-4 py-4 flex justify-between items-center" data-lang="en" onclick="selectLanguage('en')">
                    <span class="text-base">English</span>
                    <i class="fa fa-check text-primary hidden" id="lang-check-en"></i>
                </button>
            </div>
            
            <!-- 取消按钮 -->
            <div class="px-4 py-3 border-t border-border bg-white safe-bottom">
                <button id="close-lang-btn" class="touchable text-center w-full py-3 text-primary font-medium" onclick="closeLangModal()">
                    取消
                </button>
            </div>
        </div>
    </div>
    

    <!-- 扫码功能替代实现 -->
    <script>
        function Html5Qrcode(elementId) {
            this.elementId = elementId;
        }
        
        Html5Qrcode.prototype.start = function() {
            alert('扫码功能需要摄像头权限，请手动输入设备SN码');
            return Promise.reject('Camera not available');
        };
        
        Html5Qrcode.prototype.stop = function() {
            return Promise.resolve();
        };
    </script>

    <script>
        // 语言翻译数据
        const translations = {
            en: {
                company_info: 'CovaU Pty Ltd (ABN 54 090 117 730)',
                enquiries_label: 'Enquiries: ',
                form_title: 'Customer Authorisation and Consent for VPP Platform',
                dear_customer: 'Dear Customer,',
                welcome_message: 'Thank you for choosing CovaU as your Virtual Power Plant (VPP) provider.',
                form_description: 'This Authorisation Form is intended to grant your consent and authorisation to CovaU, allowing us to perform the services we provide to you as part of the operation of our VPP, as well as the services you provide to us, including granting CovaU access to and control over your Battery.',
                vpp_definition: 'means CovaU "VPP Platform" system which will communicate with, access and control your Eligible Battery System during VPP Events, as may be updated from time to time by CovaU.',
                form_notice: 'Before signing the Form, please make sure all your details and system details are correct.',
                customer_authorization: 'Customer Authorization',
                installer_information: 'Installer Information',
                installer_info_title: 'Installer Information',
                installer_info_note: 'Note: Only applicable when customers have requested battery installation',
                customer_details: 'Customer Details',
                system_details: 'System Details',
                customer_signature_info: 'Customer Signature Information',
                customer_name: 'Customer Name',
                mobile: 'Mobile',
                email: 'Email',
                nmi: 'NMI',
                supply_address: 'Supply Address',
                address: 'Address',
                status: 'Status',
                battery_brand: 'Brand',
                account: 'User Name',
                inverter_sn: 'Inverter SN',
                battery_capacity: 'Battery Capacity',
                installer_name: 'Installer Name',
                installer_company: 'Company',
                installer_license: 'License Number',
                installer_signature_date: 'Installer Signature Date',
                installer_signature_label: 'Installer Signature',
                installer_signature_hint: 'Please sign above',
                signature_date: 'Signature Date',
                customer_signature_label: 'Customer Signature',
                customer_signature: 'Customer Signature',
                signature_label: 'Signature',
                signature_hint: 'Please sign above',
                clear_signature: 'Clear',
                next_step: 'Next Step',
                prev_step: 'Previous Step',
                submit_form: 'Submit',
                review_info: 'Review Information',
                review_message: 'Please review your information before final submission',
                confirm_submit: 'Confirm & Submit',
                submit_success: 'Submit Success',
                success_message: 'VPP Authorization has been successfully submitted',
                view_details: 'View Details',
                new_submission: 'New Submission', 
                edit_info: 'Edit Information',
                query_btn: 'Query',
                do_query: 'Query',
                no_data: 'No account information found',
                query_failed: 'Query Failed',
                auth_status: 'Authorization Status',
                authorized: 'Authorized',
                unauthorized: 'Unauthorized',
                authorizing: 'Authorizing',
                rejected: 'Rejected',
                exited: 'Exited',
                resubmit: 'Resubmit',
                privacy_read_btn: 'I Have Read',
                privacy_title: 'Privacy Policy',
                select_address_title: 'Select Address',
                select_brand_title: 'Select Brand',
                please_select_brand: 'Please select brand',
                popular_addresses: 'Popular Addresses',
                manual_input: 'Manual Input',
                confirm: 'Confirm',
                current_lang: 'EN',
                submit_time: 'Submit Time',
                view_details: 'View Details',
                authorization_1: 'Authorization 1',
                authorization_2: 'Authorization 2',
            },
            zh: {
                company_info: 'CovaU有限公司 (ABN 54 090 117 730)',
                enquiries_label: '咨询电话：',
                form_title: 'VPP平台客户授权同意书',
                dear_customer: '尊敬的客户，',
                welcome_message: '感谢您选择CovaU作为您的虚拟电厂(VPP)服务提供商。',
                form_description: '此授权表单旨在获得您的同意和授权，允许CovaU在我们的VPP运营过程中为您提供服务，以及您向我们提供的服务，包括授予CovaU访问和控制您的电池系统的权限。',
                vpp_definition: '是指CovaU的"VPP平台"系统，该系统将在VPP事件期间与您的合格电池系统进行通信、访问和控制，CovaU可能会不时更新该系统。',
                form_notice: '在签署表单之前，请确保您的所有详细信息和系统详细信息都是正确的。',
                customer_authorization: '客户授权',
                installer_information: '安装人员信息',
                installer_info_title: '安装人员信息',
                installer_info_note: '注：仅适用于客户要求电池安装的情况',
                customer_details: '客户详情',
                system_details: '系统详情',
                customer_signature_info: '客户签名信息',
                customer_name: '客户姓名',
                mobile: '手机号',
                email: '邮箱',
                nmi: 'NMI',
                supply_address: '供电地址',
                address: '地址',
                status: '状态',
                battery_brand: '品牌',
                account: '用户名',
                inverter_sn: '逆变器SN',
                battery_capacity: '电池容量',
                installer_name: '安装人员姓名',
                installer_company: '安装公司',
                installer_license: '安装人员执照号',
                installer_signature_date: '安装人员签名日期',
                installer_signature_label: '安装人员签名',
                installer_signature_hint: '请在上方区域签名',
                signature_date: '签名日期',
                customer_signature_label: '客户签名',
                customer_signature: '客户签名',
                signature_label: '签名确认',
                signature_hint: '请在上方区域签名',
                clear_signature: '清除',
                next_step: '下一步',
                prev_step: '上一步',
                submit_form: '提交',
                review_info: '确认信息',
                review_message: '请确认您的信息无误后再提交',
                confirm_submit: '确认提交',
                submit_success: '提交成功',
                success_message: 'VPP授权书已成功提交',
                edit_info: '修改信息',
                query_btn: '查询',
                do_query: '查询',
                no_data: '暂未查询到该账号信息',
                query_failed: '查询失败',
                auth_status: '授权状态',
                authorized: '已授权',
                unauthorized: '未授权',
                authorizing: '授权中',
                rejected: '已驳回',
                exited: '已退出',
                resubmit: '重新提交',
                privacy_read_btn: '我已阅读',
                privacy_title: '隐私政策',
                select_address_title: '选择地址',
                select_brand_title: '选择品牌',
                please_select_brand: '请选择品牌',
                popular_addresses: '热门地址',
                manual_input: '手动输入地址',
                confirm: '确认',
                current_lang: '中文',
                submit_time: '提交时间',
                view_details: '查看详情',
                authorization_1: '授权1',
                authorization_2: '授权2',
            }
        };

        let currentLang = 'en';
        let signaturePad;
        let installerSignaturePad;
        let privacyEnabled = false;

        // 更新地址选项显示语言
        function updateAddressOptions(lang) {
            const addressItems = document.querySelectorAll('.address-item');
            
            if (lang === 'en') {
                const enAddresses = [
                    { value: 'Sydney, NSW, Australia', display: 'Sydney', subtitle: 'New South Wales, Australia' },
                    { value: 'Melbourne, VIC, Australia', display: 'Melbourne', subtitle: 'Victoria, Australia' },
                    { value: 'Brisbane, QLD, Australia', display: 'Brisbane', subtitle: 'Queensland, Australia' },
                    { value: 'Perth, WA, Australia', display: 'Perth', subtitle: 'Western Australia, Australia' },
                    { value: 'Adelaide, SA, Australia', display: 'Adelaide', subtitle: 'South Australia, Australia' },
                ];
                
                addressItems.forEach((item, index) => {
                    if (index < enAddresses.length) {
                        item.dataset.address = enAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-xs');
                        if (titleEl) titleEl.textContent = enAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = enAddresses[index].subtitle;
                    }
                });
            } else {
                const zhAddresses = [
                    { value: '悉尼, 新南威尔士州, 澳大利亚', display: '悉尼', subtitle: '新南威尔士州, 澳大利亚' },
                    { value: '墨尔本, 维多利亚州, 澳大利亚', display: '墨尔本', subtitle: '维多利亚州, 澳大利亚' },
                    { value: '布里斯班, 昆士兰州, 澳大利亚', display: '布里斯班', subtitle: '昆士兰州, 澳大利亚' },
                    { value: '珀斯, 西澳大利亚州, 澳大利亚', display: '珀斯', subtitle: '西澳大利亚州, 澳大利亚' },
                    { value: '阿德莱德, 南澳大利亚州, 澳大利亚', display: '阿德莱德', subtitle: '南澳大利亚州, 澳大利亚' },
                ];
                
                addressItems.forEach((item, index) => {
                    if (index < zhAddresses.length) {
                        item.dataset.address = zhAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-xs');
                        if (titleEl) titleEl.textContent = zhAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = zhAddresses[index].subtitle;
                    }
                });
            }
        }

        // 语言切换函数
        function changeLanguage(lang) {
            currentLang = lang;
            // 设置body的data-lang属性来控制语言显示
            document.body.setAttribute('data-lang', lang);
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            // 更新placeholder
            const placeholders = {
                'customerName': lang === 'zh' ? '请输入客户姓名' : 'Enter customer name',
                'mobile': lang === 'zh' ? '请输入手机号码' : 'Enter mobile number',
                'email': lang === 'zh' ? '请输入电子邮箱地址' : 'Enter email address',
                'nmi': lang === 'zh' ? 'Enter NMI number' : 'Enter NMI number',
                'supplyAddress': lang === 'zh' ? '请输入供电地址' : 'Enter supply address',
                'batteryAccount': lang === 'zh' ? '请输入用户名' : 'Enter user name',
                'inverterSN': lang === 'zh' ? '请输入逆变器序列号' : 'Enter inverter serial number',
                'batteryCapacity': lang === 'zh' ? '请输入电池容量 (如: 13.5kWh)' : 'Enter battery capacity (e.g.: 13.5kWh)',
                'installerName': lang === 'zh' ? '请输入安装人员姓名' : 'Enter installer name',
                'installerCompany': lang === 'zh' ? '请输入安装公司' : 'Enter company name',
                'installerLicense': lang === 'zh' ? '请输入执照号' : 'Enter license number',
                'email-input': lang === 'zh' ? '请输入邮箱地址' : 'Enter email address',
                'mobile-input': lang === 'zh' ? '请输入手机号码' : 'Enter mobile number',
                'addressDetails': lang === 'zh' ? '补充地址信息（单元号、楼宇名称等）' : 'Additional address info (unit number, building name, etc.)',
                'batteryCapacityPlaceholder': lang === 'zh' ? '例如: 100Ah' : 'e.g.: 100Ah'
            };
            
            Object.keys(placeholders).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.placeholder = placeholders[id];
            });
            
            document.getElementById('current-lang').textContent = translations[lang].current_lang;
            updateAddressOptions(lang);
            
            // 更新语言选择器勾选状态
            document.getElementById('lang-check-zh').classList.toggle('hidden', lang !== 'zh');
            document.getElementById('lang-check-en').classList.toggle('hidden', lang !== 'en');
        }
        
        // 确保主翻译函数全局可访问
        window.changeLanguage = changeLanguage;


        
        // 简单测试函数
        function testClick() {
            alert('点击测试成功！');
        }
        window.testClick = testClick;

        // 简单的测试函数
        function testButtonClick() {
            alert('按钮点击测试成功！');
            console.log('Button click test successful!');
        }
        
        // 确保函数可以全局访问
        window.testButtonClick = testButtonClick;
        
        
        function openQueryPage() {
            const formPage = document.getElementById('form-page');
            const successPage = document.getElementById('success-page');
            const queryPage = document.getElementById('query-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            const queryResult = document.getElementById('query-result');
            const noDataMessage = document.getElementById('no-data-message');
            
            formPage.classList.add('hidden');
            successPage.classList.add('hidden');
            queryPage.classList.remove('hidden');
            submitBtnContainer.classList.add('hidden');
            queryResult.classList.add('hidden');
            noDataMessage.classList.add('hidden');
        }
        
        function openBrandModal(target) {
            const brandModal = document.getElementById('brand-modal');
            if (brandModal) {
                brandModal.classList.remove('hidden');
                window.currentBrandTarget = target; // 记录当前目标
            }
        }
        
        function selectBrand(brandValue) {
            const target = window.currentBrandTarget || 'form';
            
            if (target === 'form') {
                const brandInput = document.getElementById('batteryBrand');
                const brandDisplay = document.getElementById('brand-display');
                
                brandInput.value = brandValue;
                brandDisplay.textContent = brandValue;
                brandDisplay.classList.remove('text-tertiary');
                brandDisplay.classList.add('text-secondary');
            } else if (target === 'query') {
                const queryBrandInput = document.getElementById('query-brand');
                const queryBrandDisplay = document.getElementById('query-brand-display');
                
                queryBrandInput.value = brandValue;
                queryBrandDisplay.textContent = brandValue;
                queryBrandDisplay.classList.remove('text-tertiary');
                queryBrandDisplay.classList.add('text-secondary');
            }
            
            // 关闭模态框
            const brandModal = document.getElementById('brand-modal');
            if (brandModal) {
                brandModal.classList.add('hidden');
            }
        }
        
        function editInfo() {
            console.log('editInfo 函数被调用');
            
            // 切换页面 - 直接回到表单页面
            const successPage = document.getElementById('success-page');
            const formPage = document.getElementById('form-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            console.log('Elements found:', {
                successPage: !!successPage,
                formPage: !!formPage,
                submitBtnContainer: !!submitBtnContainer
            });
            
            if (successPage) successPage.classList.add('hidden');
            if (formPage) formPage.classList.remove('hidden');
            if (submitBtnContainer) submitBtnContainer.classList.add('hidden');
            
            // 应用当前语言翻译
            if (typeof changeLanguage === 'function' && window.currentLang) {
                setTimeout(() => changeLanguage(window.currentLang), 50);
            }
        }
        
        function backToForm() {
            const queryPage = document.getElementById('query-page');
            const formPage = document.getElementById('form-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            queryPage.classList.add('hidden');
            formPage.classList.remove('hidden');
            submitBtnContainer.classList.remove('hidden');
        }
        
        function openConditionModal() {
            const conditionModal = document.createElement('div');
            conditionModal.id = 'condition-modal';
            conditionModal.className = 'fixed inset-0 bg-black/50 z-50 flex items-end';
            conditionModal.innerHTML = `
                <div class="w-full bg-white rounded-t-3xl p-4 pb-safe">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-secondary">选择查询条件</h3>
                        <button onclick="closeConditionModal()" class="touchable w-8 h-8 flex items-center justify-center rounded-full bg-light">
                            <i class="fa fa-times text-tertiary"></i>
                        </button>
                    </div>
                    <div class="py-2">
                        <button onclick="selectCondition('mobile', '手机号')" class="touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors">
                            <span class="text-base">手机号</span>
                        </button>
                        <button onclick="selectCondition('email', '邮箱')" class="touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors">
                            <span class="text-base">邮箱</span>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(conditionModal);
        }
        
        function closeConditionModal() {
            const modal = document.getElementById('condition-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function selectCondition(value, displayText) {
            const conditionInput = document.getElementById('query-condition');
            const conditionDisplay = document.getElementById('query-condition-display');
            const valueLabel = document.getElementById('query-value-label');
            const valueInput = document.getElementById('query-value-input');
            
            conditionInput.value = value;
            conditionDisplay.textContent = displayText;
            conditionDisplay.classList.remove('text-tertiary');
            conditionDisplay.classList.add('text-secondary');
            
            valueLabel.textContent = displayText;
            valueInput.placeholder = `请输入${displayText}`;
            
            closeConditionModal();
        }
        
        function performQuery() {
            console.log('查询函数被调用');
            
            // 获取输入框的值
            const emailInput = document.getElementById('email-input').value.trim();
            const mobileInput = document.getElementById('mobile-input').value.trim();
            
            console.log('查询条件 - 邮箱:', emailInput, '手机号:', mobileInput);
            
            // 5种查询结果场景切换
            const scenarios = [
                'single_authorizing',    // 第一种：1个授权书，授权中，有编辑按钮
                'single_authorized',     // 第二种：1个授权书，已授权，有编辑按钮
                'single_rejected',       // 第三种：1个授权书，已驳回，重新提交按钮
                'single_exited',         // 第四种：1个授权书，已退出，无按钮
                'two_records'            // 第五种：2个授权书，授权中有编辑，已授权无编辑
            ];
            
            if (!window.queryScenarioIndex) {
                window.queryScenarioIndex = 0;
            }
            
            const scenario = scenarios[window.queryScenarioIndex];
            window.queryScenarioIndex = (window.queryScenarioIndex + 1) % scenarios.length;
            
            console.log('当前场景:', scenario);
            
            const queryResult = document.getElementById('query-result');
            const noDataMessage = document.getElementById('no-data-message');
            
            const resultContent = document.getElementById('query-result-content');
                
            // 处理5种不同的查询场景
            if (scenario === 'single_authorizing') {
                // 第一种：1个授权书，授权中，有编辑按钮
                resultContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">John Smith</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917159</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">123 Collins Street, Melbourne VIC 3000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-05 14:30:22</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-warning/10 text-warning" data-i18n="authorizing">Authorizing</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('authorizing')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (scenario === 'single_authorized') {
                // 第二种：1个授权书，已授权，有编辑按钮
                resultContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">Sarah Johnson</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917160</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">456 George Street, Sydney NSW 2000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-04 16:45:18</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-success/10 text-success" data-i18n="authorized">Authorized</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('authorized')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (scenario === 'single_rejected') {
                // 第三种：1个授权书，已驳回，重新提交按钮
                resultContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">Michael Brown</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917161</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">789 Swanston Street, Melbourne VIC 3000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-03 10:20:15</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-danger/10 text-danger" data-i18n="rejected">Rejected</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('rejected')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (scenario === 'single_exited') {
                // 第四种：1个授权书，已退出，无按钮
                resultContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">Emily Davis</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917162</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">321 Queen Street, Brisbane QLD 4000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-02 08:15:33</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-gray-100 text-gray-600" data-i18n="exited">Exited</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('exited')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (scenario === 'two_records') {
                // 第五种：2个授权书，一个授权中（有编辑），一个已授权（无编辑）
                resultContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">David Wilson</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917163</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">555 Collins Street, Melbourne VIC 3000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-05 14:30:22</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-warning/10 text-warning" data-i18n="authorizing">Authorizing</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('two_authorizing')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white border border-gray-100 rounded-xl p-4">
                            <div class="space-y-3">
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="customer_name">Customer Name</span>
                                        <span class="text-sm text-secondary">Lisa Taylor</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary">NMI</span>
                                        <span class="text-sm text-secondary">6305917164</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="address">Address</span>
                                        <span class="text-sm text-secondary">777 George Street, Sydney NSW 2000</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="submit_time">Submit Time</span>
                                        <span class="text-sm text-secondary">2025-09-04 16:45:18</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-tertiary" data-i18n="status">Status</span>
                                        <span class="text-sm px-2 py-1 rounded-full bg-success/10 text-success" data-i18n="authorized">Authorized</span>
                                    </div>
                                </div>
                                <button onclick="showRecordDetail('two_authorized')" class="btn-outline-black w-full mt-3">
                                    <span data-i18n="view_details">View Details</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            queryResult.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
            
            // 应用当前语言翻译到新生成的内容
            if (typeof changeLanguage === 'function' && window.currentLang) {
                setTimeout(() => changeLanguage(window.currentLang), 50);
            }
        }
        
        
        
        function submitForm() {
            console.log('submitForm called');
            
            
            const formPage = document.getElementById('form-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            
            // 生成仿真数据
            const mockNames = ['John Smith', 'Mike Johnson', 'Sarah Wilson', 'David Brown', 'Lisa Chen', 'Tom Wilson', 'Emma Davis', 'James Miller'];
            const mockEmails = ['user1@example.com', 'user2@gmail.com', 'test@qq.com', 'demo@163.com'];
            const mockAddresses = ['123 CBD Street, Sydney NSW 2000', '456 South Yarra Ave, Melbourne VIC 3141', '789 Queensland Road, Brisbane QLD 4000', '101 Adelaide Street, Adelaide SA 5000'];
            
            // 获取或生成表单数据
            const customerName = document.getElementById('customerName').value || mockNames[Math.floor(Math.random() * mockNames.length)];
            const mobile = document.getElementById('mobile').value || `04${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`;
            const email = document.getElementById('email').value || mockEmails[Math.floor(Math.random() * mockEmails.length)];
            const nmi = document.getElementById('nmi').value || `NMI${Math.floor(Math.random() * 10000000000).toString().padStart(10, '0')}`;
            const supplyAddress = document.getElementById('supplyAddress').value || mockAddresses[Math.floor(Math.random() * mockAddresses.length)];
            const addressDetails = document.getElementById('addressDetails').value || '';
            const brandValue = document.getElementById('batteryBrand').value || 'FOX ESS';
            const brandDisplay = document.getElementById('brand-display').textContent || 'FOX ESS';
            const batteryAccount = document.getElementById('batteryAccount').value || `ACC${Math.floor(Math.random() * 100000).toString().padStart(6, '0')}`;
            const inverterSN = document.getElementById('inverterSN').value || `INV${Math.floor(Math.random() * 1000000).toString().padStart(8, '0')}`;
            const batterySN = `BAT${Math.floor(Math.random() * 1000000).toString().padStart(8, '0')}`;
            const batteryCapacity = document.getElementById('batteryCapacity').value || `${Math.floor(Math.random() * 50 + 10)}kWh`;
            const signatureDate = document.getElementById('signatureDate').value || new Date().toISOString().split('T')[0];
            
            // 获取或生成安装人员信息（由于删除了第二步，这些字段不存在，直接生成模拟数据）
            const installerNames = ['John Smith', 'Mike Johnson', 'David Brown', 'Chris Wilson'];
            const installerCompanies = ['Solar Install Pro', 'Green Energy Solutions', 'Power Tech Systems', 'Eco Solar Group'];
            const installerName = installerNames[Math.floor(Math.random() * installerNames.length)];
            const installerCompany = installerCompanies[Math.floor(Math.random() * installerCompanies.length)];
            const installerLicense = `LIC${Math.floor(Math.random() * 100000).toString().padStart(6, '0')}`;
            const installerSignatureDate = new Date().toISOString().split('T')[0];
            
            // 检查实际签名
            const hasSignature = signaturePad && !signaturePad.isEmpty();
            const hasInstallerSignature = false; // 由于删除了安装人员签名字段，设为false
            
            // 合并完整地址
            const fullAddress = addressDetails ? `${supplyAddress}, ${addressDetails}` : supplyAddress;
            
            // 显示提交信息
            document.getElementById('display-customer-name').textContent = customerName || '--';
            document.getElementById('display-mobile').textContent = mobile || '--';
            document.getElementById('display-email').textContent = email || '--';
            document.getElementById('display-nmi').textContent = nmi || '--';
            document.getElementById('display-supply-address').textContent = fullAddress || '--';
            document.getElementById('display-brand').textContent = brandValue ? brandDisplay : '--';
            document.getElementById('display-account').textContent = batteryAccount || '--';
            document.getElementById('display-inverter-sn').textContent = inverterSN || '--';
            document.getElementById('display-battery-sn').textContent = batterySN || '--';
            document.getElementById('display-battery-capacity').textContent = batteryCapacity || '--';
            document.getElementById('display-signature-date').textContent = signatureDate;
            
            // 授权状态
            const isAuthorized = Math.random() > 0.3;
            const authStatusMain = document.getElementById('display-auth-status-main');
            
            if (authStatusMain) {
                authStatusMain.textContent = isAuthorized ? 
                    (translations[currentLang].authorized || 'Authorized') : 
                    (translations[currentLang].unauthorized || 'Unauthorized');
                if (isAuthorized) {
                    authStatusMain.className = 'font-medium text-sm px-3 py-1 rounded-full bg-success/10 text-success';
                } else {
                    authStatusMain.className = 'font-medium text-sm px-3 py-1 rounded-full bg-warning/10 text-warning';
                }
            }
            
            // 生成仿真签名
            function generateMockSignature(name) {
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // 设置签名样式
                ctx.fillStyle = '#000000';
                ctx.font = '24px cursive';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // 绘制签名文字
                ctx.fillText(name, canvas.width/2, canvas.height/2);
                
                return canvas.toDataURL('image/png');
            }
            
            // 显示客户签名
            const signatureContainer = document.getElementById('display-signature-container');
            if (signatureContainer) {
                if (hasSignature) {
                    const img = document.createElement('img');
                    img.src = signaturePad.toDataURL('image/png');
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    signatureContainer.innerHTML = '';
                    signatureContainer.appendChild(img);
                } else {
                    // 生成仿真签名
                    const img = document.createElement('img');
                    img.src = generateMockSignature(customerName);
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    signatureContainer.innerHTML = '';
                    signatureContainer.appendChild(img);
                }
            }
            
            // 显示安装人员签名
            const installerSignatureContainer = document.getElementById('display-installer-signature-container');
            if (installerSignatureContainer) {
                if (hasInstallerSignature) {
                    const img = document.createElement('img');
                    img.src = installerSignaturePad.toDataURL('image/png');
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    installerSignatureContainer.innerHTML = '';
                    installerSignatureContainer.appendChild(img);
                } else {
                    // 生成仿真签名
                    const img = document.createElement('img');
                    img.src = generateMockSignature(installerName);
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    installerSignatureContainer.innerHTML = '';
                    installerSignatureContainer.appendChild(img);
                }
            }
            
            // 隐藏步骤指示器
            const stepIndicator = document.getElementById('progress-steps');
            if (stepIndicator) {
                stepIndicator.classList.add('hidden');
            }
            
            // 切换页面
            formPage.classList.add('hidden');
            successPage.classList.remove('hidden');
            submitBtnContainer.classList.add('hidden');
            
            // 应用当前语言翻译到成功页面
            if (typeof changeLanguage === 'function' && window.currentLang) {
                setTimeout(() => changeLanguage(window.currentLang), 50);
            }
        }

        // 显示状态消息
        function showStatusMessage(message, type = 'info') {
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.className = 'fixed top-40 left-4 right-4 p-3 rounded-xl status-message z-50 safe-top';
            if (type === 'success') {
                statusMessage.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-danger', 'text-white');
            } else {
                statusMessage.classList.add('bg-primary', 'text-white');
            }
            
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // 初始化签名板
        function initSignaturePad() {
            // 客户签名板
            const canvas = document.getElementById('signature-pad');
            // 安装人员签名板
            const installerCanvas = document.getElementById('installer-signature-pad');
            
            function resizeCanvas(canvasElement, padInstance) {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvasElement.width = canvasElement.offsetWidth * ratio;
                canvasElement.height = canvasElement.offsetHeight * ratio;
                canvasElement.getContext('2d').scale(ratio, ratio);
                if (padInstance) padInstance.clear();
            }
            
            window.addEventListener('resize', function() {
                resizeCanvas(canvas, signaturePad);
                if (installerCanvas) resizeCanvas(installerCanvas, installerSignaturePad);
            });
            
            resizeCanvas(canvas);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                velocityFilterWeight: 0.7,
                minWidth: 1.5,
                maxWidth: 3
            });
            
            if (installerCanvas) {
                resizeCanvas(installerCanvas);
                
                installerSignaturePad = new SignaturePad(installerCanvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)',
                    velocityFilterWeight: 0.7,
                    minWidth: 1.5,
                    maxWidth: 3
                });
                
                // 清除安装人员签名按钮已删除，跳过事件监听器
            }
            
            // 清除客户签名
            document.getElementById('clear-signature-btn').addEventListener('click', function() {
                signaturePad.clear();
            });
        }

        // 初始化地址和定位功能
        function initLocationFeatures() {
            const addressInput = document.getElementById('supplyAddress');
            const refreshLocationBtn = document.getElementById('refresh-location-btn');
            const selectRegionBtn = document.getElementById('select-region-btn');
            const addressModal = document.getElementById('address-modal');
            const closeAddressBtn = document.getElementById('close-address-btn');
            const searchInput = document.getElementById('address-search');
            const manualInput = document.getElementById('manual-address-input');
            const confirmBtn = document.getElementById('confirm-manual-address');
            
            // 页面加载时自动尝试获取位置
            setTimeout(() => {
                getCurrentLocation();
            }, 500);
            
            // 获取当前位置
            function getCurrentLocation() {
                addressInput.placeholder = translations[currentLang].getting_location || 'Getting location...';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            // 尝试反向地理编码获取地址
                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=${currentLang}`,
                                    {
                                        headers: {
                                            'User-Agent': 'AuthorizationForm/1.0'
                                        }
                                    }
                                );
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.display_name) {
                                        addressInput.value = data.display_name;
                                        addressInput.placeholder = '设备地址';
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.error('Reverse geocoding error:', error);
                            }
                            
                            // 如果反向地理编码失败，显示坐标
                            addressInput.value = `纬度: ${lat.toFixed(6)}, 经度: ${lon.toFixed(6)}`;
                            addressInput.placeholder = '设备地址';
                        },
                        function(error) {
                            console.error('Location error:', error);
                            addressInput.placeholder = '无法获取位置，请手动输入';
                            
                            // 尝试IP定位作为备选
                            getLocationByIP();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    addressInput.placeholder = '浏览器不支持定位，请手动输入';
                }
            }
            
            // 通过IP获取大概位置
            async function getLocationByIP() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.city && data.country_name) {
                        const address = currentLang === 'zh' 
                            ? `${data.country_name} ${data.region} ${data.city}` 
                            : `${data.city}, ${data.region}, ${data.country_name}`;
                        
                        addressInput.value = address;
                        addressInput.placeholder = '设备地址';
                    }
                } catch (error) {
                    console.error('IP location error:', error);
                }
            }
            
            // 刷新位置按钮
            refreshLocationBtn.addEventListener('click', function() {
                getCurrentLocation();
            });
            
            // 选择地区按钮
            selectRegionBtn.addEventListener('click', function() {
                addressModal.classList.remove('hidden');
            });
            
            // 关闭地址选择模态框
            function closeAddressModal() {
                addressModal.classList.add('hidden');
            }
            
            closeAddressBtn.addEventListener('click', closeAddressModal);
            addressModal.addEventListener('click', function(e) {
                if (e.target === addressModal) closeAddressModal();
            });
            
            // 选择地址项
            document.querySelectorAll('.address-item').forEach(item => {
                item.addEventListener('click', function() {
                    const address = this.dataset.address;
                    addressInput.value = address;
                    closeAddressModal();
                });
            });
            
            // 搜索地址
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.address-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
            
            // 手动输入地址
            confirmBtn.addEventListener('click', function() {
                const address = manualInput.value.trim();
                if (address) {
                    addressInput.value = address;
                    manualInput.value = '';
                    closeAddressModal();
                }
            });
            
        }

        // 初始化隐私协议
        function initPrivacy() {
            const privacyCheckbox = document.getElementById('privacy-agreement');
            const privacyHint = document.getElementById('privacy-hint');
            const privacyModal = document.getElementById('privacy-modal');
            const closePrivacyBtn = document.getElementById('close-privacy-btn');
            const privacyReadBtn = document.getElementById('privacy-read-btn');
            const privacyLinks = document.querySelectorAll('.privacy-link');
            
            // 检查必要元素是否存在
            if (!privacyCheckbox) {
                console.log('Privacy elements not found, skipping privacy init');
                return;
            }
            
            // 点击复选框时检查是否已阅读
            privacyCheckbox.addEventListener('click', function(e) {
                if (!privacyEnabled) {
                    e.preventDefault();
                    privacyModal.classList.remove('hidden');
                }
            });
            
            // 打开隐私政策
            if (privacyLinks && privacyLinks.length > 0) {
                privacyLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (privacyModal) privacyModal.classList.remove('hidden');
                    });
                });
            }
            
            // 关闭隐私政策
            function closePrivacyModal() {
                privacyModal.classList.add('hidden');
            }
            
            closePrivacyBtn.addEventListener('click', closePrivacyModal);
            privacyModal.addEventListener('click', function(e) {
                if (e.target === privacyModal) closePrivacyModal();
            });
            
            // 已阅读按钮
            privacyReadBtn.addEventListener('click', function() {
                privacyEnabled = true;
                privacyCheckbox.disabled = false;
                privacyCheckbox.checked = true;
                privacyHint.classList.add('hidden');
                closePrivacyModal();
            });
        }

        // 初始化语言选择
        function initLanguageSelector() {
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const langModal = document.getElementById('lang-modal');
            const closeLangBtn = document.getElementById('close-lang-btn');
            const langOptions = document.querySelectorAll('.lang-option');
            
            langToggleBtn.addEventListener('click', function() {
                langModal.classList.remove('hidden');
            });
            
            closeLangBtn.addEventListener('click', function() {
                langModal.classList.add('hidden');
            });
            
            langModal.addEventListener('click', function(e) {
                if (e.target === langModal) {
                    langModal.classList.add('hidden');
                }
            });
            
            langOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    changeLanguage(lang);
                    langModal.classList.add('hidden');
                });
            });
        }

        // 初始化表单提交
        function initFormSubmit() {
            const form = document.getElementById('vpp-form');
            const formPage = document.getElementById('form-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            const editBtn = document.getElementById('edit-btn');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取VPP表单数据
                const customerName = document.getElementById('customerName').value || '--';
                const mobile = document.getElementById('mobile').value || '--';
                const email = document.getElementById('email').value || '--';
                const nmi = document.getElementById('nmi').value || '--';
                const supplyAddress = document.getElementById('supplyAddress').value || '--';
                const addressDetails = document.getElementById('addressDetails').value || '';
                const brandValue = document.getElementById('batteryBrand').value;
                const brandDisplay = document.getElementById('brand-display').textContent;
                const batteryAccount = document.getElementById('batteryAccount').value || '--';
                const inverterSN = document.getElementById('inverterSN').value || '--';
                const batteryCapacity = document.getElementById('batteryCapacity').value || '--';
                const signatureDate = document.getElementById('signatureDate').value || new Date().toISOString().split('T')[0];
                const hasSignature = !signaturePad.isEmpty();
                
                // 获取安装人员信息（字段已删除，使用模拟数据）
                const installerNames = ['John Smith', 'Mike Johnson', 'David Brown', 'Chris Wilson'];
                const installerCompanies = ['Solar Install Pro', 'Green Energy Solutions', 'Power Tech Systems', 'Eco Solar Group'];
                const installerName = installerNames[Math.floor(Math.random() * installerNames.length)];
                const installerCompany = installerCompanies[Math.floor(Math.random() * installerCompanies.length)];
                const installerLicense = `LIC${Math.floor(Math.random() * 100000).toString().padStart(6, '0')}`;
                const installerSignatureDate = new Date().toISOString().split('T')[0];
                const hasInstallerSignature = false;
                
                // 合并完整地址
                const fullAddress = addressDetails ? `${supplyAddress}, ${addressDetails}` : supplyAddress;
                
                // 显示提交信息
                document.getElementById('display-customer-name').textContent = customerName;
                document.getElementById('display-mobile').textContent = mobile;
                document.getElementById('display-email').textContent = email;
                document.getElementById('display-nmi').textContent = nmi;
                document.getElementById('display-supply-address').textContent = fullAddress;
                document.getElementById('display-brand').textContent = brandValue ? brandDisplay : '--';
                document.getElementById('display-account').textContent = batteryAccount;
                document.getElementById('display-inverter-sn').textContent = inverterSN;
                document.getElementById('display-battery-sn').textContent = `BAT${Math.floor(Math.random() * 1000000).toString().padStart(8, '0')}`;
                document.getElementById('display-battery-capacity').textContent = batteryCapacity;
                document.getElementById('display-signature-date').textContent = signatureDate;
                
                // 授权状态
                const isAuthorized = Math.random() > 0.3;
                const authStatus = document.getElementById('display-auth-status');
                authStatus.textContent = isAuthorized ? translations[currentLang].authorized : translations[currentLang].unauthorized;
                authStatus.className = isAuthorized ? 'font-medium text-sm text-success' : 'font-medium text-sm text-warning';
                
                // 显示客户签名
                const signatureContainer = document.getElementById('display-signature-container');
                if (hasSignature) {
                    const img = document.createElement('img');
                    img.src = signaturePad.toDataURL('image/png');
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    signatureContainer.innerHTML = '';
                    signatureContainer.appendChild(img);
                } else {
                    signatureContainer.innerHTML = '<span class="text-tertiary">--</span>';
                }
                
                // 显示安装人员签名
                const installerSignatureContainer = document.getElementById('display-installer-signature-container');
                if (hasInstallerSignature) {
                    const installerImg = document.createElement('img');
                    installerImg.src = installerSignaturePad.toDataURL('image/png');
                    installerImg.className = 'w-full h-auto max-h-20 object-contain';
                    installerSignatureContainer.innerHTML = '';
                    installerSignatureContainer.appendChild(installerImg);
                } else {
                    installerSignatureContainer.innerHTML = '<span class="text-tertiary">--</span>';
                }
                
                // 切换页面
                formPage.classList.add('hidden');
                successPage.classList.remove('hidden');
                submitBtnContainer.classList.add('hidden');
                
                // 应用当前语言翻译到成功页面
                if (typeof changeLanguage === 'function' && window.currentLang) {
                    setTimeout(() => changeLanguage(window.currentLang), 50);
                }
            });
            
            // 编辑按钮
            editBtn.addEventListener('click', function() {
                // 显示步骤指示器
                const stepIndicator = document.getElementById('progress-steps');
                if (stepIndicator) {
                    stepIndicator.classList.remove('hidden');
                }
                
                successPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
                
                // 应用当前语言翻译
                if (typeof changeLanguage === 'function' && window.currentLang) {
                    setTimeout(() => changeLanguage(window.currentLang), 50);
                }
            });
        }

        // 初始化查询功能
        function initQuery() {
            const queryBtn = document.getElementById('query-btn');
            const backBtn = document.getElementById('back-btn');
            const doQueryBtn = document.getElementById('do-query-btn');
            const formPage = document.getElementById('form-page');
            const queryPage = document.getElementById('query-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            const queryResult = document.getElementById('query-result');
            const noDataMessage = document.getElementById('no-data-message');
            const editQueryBtn = document.getElementById('edit-query-btn');
            const queryFormBackBtn = document.getElementById('query-form-back-btn');
            
            let queryToggle = false;
            let queryResultData = null;
            
            queryBtn.addEventListener('click', function() {
                // 隐藏步骤指示器
                const stepIndicator = document.getElementById('progress-steps');
                if (stepIndicator) {
                    stepIndicator.classList.add('hidden');
                }
                
                formPage.classList.add('hidden');
                successPage.classList.add('hidden');
                queryPage.classList.remove('hidden');
                submitBtnContainer.classList.add('hidden');
                queryResult.classList.add('hidden');
                noDataMessage.classList.add('hidden');
                
                // 应用当前语言翻译到查询页面
                if (typeof changeLanguage === 'function' && window.currentLang) {
                    setTimeout(() => changeLanguage(window.currentLang), 50);
                }
            });
            
            backBtn.addEventListener('click', function() {
                // 显示步骤指示器
                const stepIndicator = document.getElementById('progress-steps');
                if (stepIndicator) {
                    stepIndicator.classList.remove('hidden');
                }
                
                queryPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
                
                // 应用当前语言翻译
                if (typeof changeLanguage === 'function' && window.currentLang) {
                    setTimeout(() => changeLanguage(window.currentLang), 50);
                }
            });
            
            // 查询条件卡片的返回按钮 - 返回到表单页面
            if (queryFormBackBtn) {
                queryFormBackBtn.addEventListener('click', function() {
                    // 显示步骤指示器
                    const stepIndicator = document.getElementById('progress-steps');
                    if (stepIndicator) {
                        stepIndicator.classList.remove('hidden');
                    }
                    
                    queryPage.classList.add('hidden');
                    formPage.classList.remove('hidden');
                    submitBtnContainer.classList.remove('hidden');
                });
            }
            
            doQueryBtn.addEventListener('click', function() {
                const brand = document.getElementById('query-brand').value;
                const account = document.getElementById('query-account-input').value;
                
                if (!brand || !account) {
                    showStatusMessage('请填写完整信息', 'error');
                    return;
                }
                
                // 按顺序循环切换查询结果场景（与桌面版保持一致）
                const scenarios = ['two_records', 'authorized', 'authorizing', 'exited', 'fail'];
                
                // 获取或初始化场景索引
                if (!window.queryScenarioIndex) {
                    window.queryScenarioIndex = 0;
                }
                
                // 获取当前场景
                const scenario = scenarios[window.queryScenarioIndex];
                
                // 更新场景索引
                window.queryScenarioIndex = (window.queryScenarioIndex + 1) % scenarios.length;
                
                if (scenario === 'fail') {
                    // 查询失败
                    queryResult.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                } else {
                    const resultContent = document.getElementById('query-result-content');
                    const brandDisplay = document.getElementById('query-brand-display').textContent;
                    
                    if (scenario === 'two_records') {
                        // 查询成功 - 显示两条记录（一个已授权，一个授权中）
                        const authorizedDevice = {
                            sn: 'SN20231125',
                            submitTime: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US'),
                            isAuthorized: true
                        };
                        
                        const authorizingDevice = {
                            sn: 'SN20241208',
                            submitTime: new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US'),
                            isAuthorized: false
                        };
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: authorizingDevice.sn,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString()
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 2 条记录' : 'Found 2 records'}
                            </div>
                            
                            <!-- 记录1 - 已授权设备 -->
                            <div class="bg-light/70 rounded-xl p-3 mb-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备 1' : 'Device 1'}</span>
                                    <span class="px-2 py-0.5 bg-success/10 text-success text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorized || '已授权'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].battery_brand || 'Brand'}:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].account || 'Account'}:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device SN:</span>
                                        <span class="font-medium">${authorizedDevice.sn}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device Address:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].submit_time || 'Submit Time'}:</span>
                                        <span class="font-medium">${authorizedDevice.submitTime}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 记录2 - 授权中设备 -->
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备 2' : 'Device 2'}</span>
                                    <span class="px-2 py-0.5 bg-warning/10 text-warning text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorizing || '授权中'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].battery_brand || 'Brand'}:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].account || 'Account'}:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device SN:</span>
                                        <span class="font-medium">${authorizingDevice.sn}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device Address:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].submit_time || 'Submit Time'}:</span>
                                        <span class="font-medium">${authorizingDevice.submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_info || 'Edit Information';
                        
                    } else if (scenario === 'authorized') {
                        // 查询成功 - 单条已授权记录
                        const deviceSN = 'SN2024' + Math.floor(Math.random() * 10000);
                        const submitTime = new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: deviceSN,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString(),
                            isAuthorized: true
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-success/10 text-success text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorized || '已授权'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].battery_brand || 'Brand'}:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].account || 'Account'}:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device SN:</span>
                                        <span class="font-medium">${deviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device Address:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].submit_time || 'Submit Time'}:</span>
                                        <span class="font-medium">${submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_info || 'Edit Information';
                        
                    } else if (scenario === 'authorizing') {
                        // 查询成功 - 单条授权中记录
                        const deviceSN = 'SN2024' + Math.floor(Math.random() * 10000);
                        const submitTime = new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: deviceSN,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString(),
                            isAuthorized: false
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-warning/10 text-warning text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorizing || '授权中'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].battery_brand || 'Brand'}:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].account || 'Account'}:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device SN:</span>
                                        <span class="font-medium">${deviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device Address:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].submit_time || 'Submit Time'}:</span>
                                        <span class="font-medium">${submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_info || 'Edit Information';
                        
                    } else if (scenario === 'exited') {
                        // 查询成功 - 单条已退出记录
                        const exitedDeviceSN = 'SN2023' + Math.floor(1000 + Math.random() * 9000);
                        const exitedSubmitTime = new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: exitedDeviceSN,
                            address: currentLang === 'zh' ? '布里斯班, 昆士兰州, 澳大利亚' : 'Brisbane, QLD, Australia',
                            meter: Math.floor(10000000 + Math.random() * 90000000).toString(),
                            isExited: true
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-danger/10 text-danger text-xs rounded-full font-medium">
                                        ${translations[currentLang].exited || '已退出'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].battery_brand || 'Brand'}:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].account || 'Account'}:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device SN:</span>
                                        <span class="font-medium">${exitedDeviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">Device Address:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '布里斯班, 昆士兰州' : 'Brisbane, QLD'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">${translations[currentLang].submit_time || 'Submit Time'}:</span>
                                        <span class="font-medium">${exitedSubmitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = currentLang === 'zh' ? '重新授权' : 'Re-authorize';
                    }
                    
                    queryResult.classList.remove('hidden');
                    noDataMessage.classList.add('hidden');
                }
            });
            
            
            editQueryBtn.addEventListener('click', function() {
                if (queryResultData) {
                    // 填充表单数据
                    document.getElementById('batteryBrand').value = queryResultData.brand;
                    document.getElementById('brand-display').textContent = queryResultData.brandDisplay;
                    document.getElementById('brand-display').classList.remove('text-tertiary');
                    document.getElementById('brand-display').classList.add('text-secondary');
                    
                    document.getElementById('user-account').value = queryResultData.account;
                    document.getElementById('device-sn').value = queryResultData.sn;
                    document.getElementById('device-address').value = queryResultData.address;
                    document.getElementById('meter-number').value = queryResultData.meter;
                    
                    showStatusMessage(translations[currentLang].edit_message || '您现在可以修改信息', 'info');
                }
                
                queryPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
                
                // 应用当前语言翻译
                if (typeof changeLanguage === 'function' && window.currentLang) {
                    setTimeout(() => changeLanguage(window.currentLang), 50);
                }
            });
        }

        // 初始化扫码功能
        function initScanner() {
            const scanBtn = document.getElementById('scan-sn-btn');
            const deviceSnInput = document.getElementById('device-sn');
            
            scanBtn.addEventListener('click', async function() {
                // 检查是否支持相机API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showStatusMessage('您的设备不支持相机功能', 'error');
                    return;
                }
                
                // 创建扫码界面
                createScannerUI();
            });
            
            function createScannerUI() {
                // 创建全屏扫码界面
                const scannerOverlay = document.createElement('div');
                scannerOverlay.className = 'fixed inset-0 bg-black z-50';
                scannerOverlay.innerHTML = `
                    <div class="relative w-full h-full">
                        <video id="scanner-video" class="w-full h-full object-cover"></video>
                        
                        <!-- 扫码框 -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="relative">
                                <div class="w-64 h-64 border-2 border-white rounded-2xl">
                                    <div class="absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-primary rounded-tl-xl"></div>
                                    <div class="absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-primary rounded-tr-xl"></div>
                                    <div class="absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-primary rounded-bl-xl"></div>
                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-primary rounded-br-xl"></div>
                                </div>
                                <div class="absolute w-full h-0.5 bg-primary top-1/2 transform -translate-y-1/2 animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- 顶部栏 -->
                        <div class="absolute top-0 left-0 right-0 safe-top bg-gradient-to-b from-black/70 to-transparent p-4">
                            <div class="flex justify-between items-center">
                                <button id="close-scanner" class="text-white p-2">
                                    <i class="fa fa-arrow-left text-2xl"></i>
                                </button>
                                <span class="text-white font-medium">扫描设备SN码</span>
                                <button id="toggle-flash" class="text-white p-2">
                                    <i class="fa fa-bolt text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 底部提示 -->
                        <div class="absolute bottom-0 left-0 right-0 safe-bottom bg-gradient-to-t from-black/70 to-transparent p-6">
                            <p class="text-white text-center mb-4">将二维码放入框内，即可自动扫描</p>
                            <button id="manual-input-scanner" class="w-full py-3 bg-white/20 backdrop-blur-md text-white rounded-xl border border-white/30">
                                手动输入
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(scannerOverlay);
                
                // 启动相机
                startCamera();
                
                // 关闭扫码
                document.getElementById('close-scanner').addEventListener('click', function() {
                    stopCamera();
                    scannerOverlay.remove();
                });
                
                // 手动输入
                document.getElementById('manual-input-scanner').addEventListener('click', function() {
                    stopCamera();
                    scannerOverlay.remove();
                    deviceSnInput.focus();
                });
                
                // 闪光灯开关
                let flashOn = false;
                document.getElementById('toggle-flash').addEventListener('click', function() {
                    flashOn = !flashOn;
                    this.classList.toggle('text-yellow-400');
                    toggleFlash(flashOn);
                });
            }
            
            let stream = null;
            let videoTrack = null;
            
            async function startCamera() {
                try {
                    const video = document.getElementById('scanner-video');
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment', // 使用后置摄像头
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    video.srcObject = stream;
                    videoTrack = stream.getVideoTracks()[0];
                    
                    // 模拟扫码成功（实际项目中需要集成真实的二维码识别库）
                    setTimeout(() => {
                        simulateScanSuccess();
                    }, 3000);
                    
                } catch (error) {
                    console.error('相机启动失败:', error);
                    showStatusMessage('无法启动相机', 'error');
                    document.querySelector('.fixed.inset-0').remove();
                }
            }
            
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
            
            function toggleFlash(on) {
                if (videoTrack && videoTrack.getCapabilities) {
                    const capabilities = videoTrack.getCapabilities();
                    if (capabilities.torch) {
                        videoTrack.applyConstraints({
                            advanced: [{ torch: on }]
                        });
                    }
                }
            }
            
            function simulateScanSuccess() {
                // 生成模拟的SN码
                const mockSN = 'SN' + Date.now().toString().slice(-10);
                deviceSnInput.value = mockSN;
                
                // 播放成功提示
                showStatusMessage('扫码成功！', 'success');
                
                // 关闭扫码界面
                stopCamera();
                const scannerOverlay = document.querySelector('.fixed.inset-0');
                if (scannerOverlay) {
                    scannerOverlay.remove();
                }
            }
        }

        // 初始化品牌选择
        function initBrandSelector() {
            const brandSelectBtn = document.getElementById('brand-select-btn');
            const queryBrandSelectBtn = document.getElementById('query-brand-select-btn');
            const brandModal = document.getElementById('brand-modal');
            const closeBrandBtn = document.getElementById('close-brand-btn');
            const brandOptions = document.querySelectorAll('.brand-option');
            
            let currentTarget = 'form'; // 'form' 或 'query'
            
            // 打开品牌选择模态框 - 表单页面
            if (brandSelectBtn) {
                brandSelectBtn.addEventListener('click', function() {
                    currentTarget = 'form';
                    brandModal.classList.remove('hidden');
                    const brandInput = document.getElementById('batteryBrand');
                    updateBrandChecks(brandInput.value);
                });
            }
            
            // 打开品牌选择模态框 - 查询页面
            if (queryBrandSelectBtn) {
                queryBrandSelectBtn.addEventListener('click', function() {
                    currentTarget = 'query';
                    brandModal.classList.remove('hidden');
                    const queryBrandInput = document.getElementById('query-brand');
                    updateBrandChecks(queryBrandInput.value);
                });
            }
            
            // 关闭品牌选择模态框
            function closeBrandModal() {
                brandModal.classList.add('hidden');
            }
            
            closeBrandBtn.addEventListener('click', closeBrandModal);
            brandModal.addEventListener('click', function(e) {
                if (e.target === brandModal) closeBrandModal();
            });
            
            // 选择品牌
            brandOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const displayText = this.querySelector('.text-base').textContent;
                    
                    // 根据当前目标更新相应的输入和显示
                    const target = window.currentBrandTarget || currentTarget || 'form';
                    
                    if (target === 'form') {
                        const brandInput = document.getElementById('batteryBrand');
                        const brandDisplay = document.getElementById('brand-display');
                        
                        brandInput.value = value;
                        brandDisplay.textContent = displayText;
                        brandDisplay.classList.remove('text-tertiary');
                        brandDisplay.classList.add('text-secondary');
                    } else if (target === 'query') {
                        const queryBrandInput = document.getElementById('query-brand');
                        const queryBrandDisplay = document.getElementById('query-brand-display');
                        
                        queryBrandInput.value = value;
                        queryBrandDisplay.textContent = displayText;
                        queryBrandDisplay.classList.remove('text-tertiary');
                        queryBrandDisplay.classList.add('text-secondary');
                    }
                    
                    // 更新勾选状态
                    updateBrandChecks(value);
                    
                    // 关闭模态框
                    setTimeout(closeBrandModal, 200);
                });
            });
            
            // 更新勾选状态
            function updateBrandChecks(selectedValue) {
                document.querySelectorAll('.brand-check').forEach(check => {
                    check.classList.add('hidden');
                });
                
                if (selectedValue) {
                    const selectedOption = document.querySelector(`.brand-option[data-value="${selectedValue}"]`);
                    if (selectedOption) {
                        selectedOption.querySelector('.brand-check').classList.remove('hidden');
                    }
                }
            }
        }

        // 图片预加载缓存
        const imageCache = new Map();
        
        // 预加载所有提示图片
        function preloadHintImages() {
            const imagesToPreload = ['账号.jpg', '逆变器SN.jpg', '电池容量.jpg'];
            imagesToPreload.forEach(src => {
                if (!imageCache.has(src)) {
                    const img = new Image();
                    img.onload = () => imageCache.set(src, img);
                    img.onerror = () => console.warn(`Failed to preload image: ${src}`);
                    img.src = src;
                }
            });
        }
        
        // 打开提示模态框
        function openHintModal(type) {
            const modal = document.getElementById('hintModal');
            const modalImage = document.getElementById('modalImage');
            const imageLoader = document.getElementById('imageLoader');
            
            // 根据类型设置图片路径和标题
            const imageMap = {
                'account': {
                    src: '账号.jpg',
                    title: { 
                        en: 'User Name', 
                        zh: '用户名' 
                    }
                },
                'inverterSN': {
                    src: '逆变器SN.jpg',
                    title: { 
                        en: 'Inverter SN', 
                        zh: '逆变器SN' 
                    }
                },
                'batteryCapacity': {
                    src: '电池容量.jpg',
                    title: { 
                        en: 'Battery Capacity', 
                        zh: '电池容量' 
                    }
                }
            };
            
            if (imageMap[type]) {
                const imageSrc = imageMap[type].src;
                
                // 更新标题
                const titleEn = document.querySelector('#modalTitle .lang-text[data-lang="en"]');
                const titleZh = document.querySelector('#modalTitle .lang-text[data-lang="zh"]');
                
                if (titleEn) titleEn.textContent = imageMap[type].title.en;
                if (titleZh) titleZh.textContent = imageMap[type].title.zh;
                
                // 显示模态框
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
                
                // 优化图片加载
                if (imageCache.has(imageSrc)) {
                    // 使用缓存的图片
                    modalImage.src = imageSrc;
                    modalImage.style.display = 'block';
                    imageLoader.classList.add('hidden');
                } else {
                    // 显示加载指示器
                    modalImage.style.display = 'none';
                    imageLoader.classList.remove('hidden');
                    
                    // 加载图片
                    const img = new Image();
                    img.onload = () => {
                        imageCache.set(imageSrc, img);
                        modalImage.src = imageSrc;
                        modalImage.style.display = 'block';
                        imageLoader.classList.add('hidden');
                    };
                    img.onerror = () => {
                        imageLoader.classList.add('hidden');
                        console.error(`Failed to load image: ${imageSrc}`);
                    };
                    img.src = imageSrc;
                }
            }
        }

        // 关闭提示模态框
        function closeHintModal() {
            const modal = document.getElementById('hintModal');
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // 恢复滚动
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认签名日期
            const signatureDateField = document.getElementById('signatureDate');
            if (signatureDateField) {
                signatureDateField.value = new Date().toISOString().split('T')[0];
            }
            
            // 安装人员签名日期字段已删除，跳过初始化
            
            initSignaturePad();
            initLocationFeatures();
            initPrivacy();
            initLanguageSelector();
            initBrandSelector();
            initFormSubmit();
            initQuery();
            initScanner();
            
            // 初始化默认语言为英文（与第一个初始化保持一致）
            changeLanguage('en');
            
            // 预加载提示图片
            preloadHintImages();
            
            // 防止iOS橡皮筋效果
            document.body.addEventListener('touchmove', function(e) {
                if (e.target.closest('.overflow-y-auto, .hide-scrollbar')) return;
                if (document.body.scrollTop === 0 && e.touches[0].clientY > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
        
        // 确认提交函数
        function confirmSubmit() {
            console.log('confirmSubmit 函数被调用');
            
            // 隐藏回顾页面
            document.getElementById('success-page').style.display = 'none';
            
            // 显示最终成功页面
            document.getElementById('final-success-page').style.display = 'block';
            
            // 滚动到顶部
            window.scrollTo(0, 0);
        }
        
        // 查看详情函数
        function viewSubmittedDetails() {
            console.log('viewSubmittedDetails 函数被调用');
            
            // 隐藏最终成功页面
            document.getElementById('final-success-page').style.display = 'none';
            
            // 显示回顾页面（只读模式）
            document.getElementById('success-page').style.display = 'block';
            
            // 禁用编辑和确认按钮
            document.getElementById('confirm-submit-btn').style.display = 'none';
            document.getElementById('edit-btn').style.display = 'none';
            
            // 滚动到顶部
            window.scrollTo(0, 0);
        }
        
        // 新提交函数
        function startNewSubmission() {
            console.log('startNewSubmission 函数被调用');
            
            // 重置所有页面显示状态
            document.getElementById('final-success-page').style.display = 'none';
            document.getElementById('success-page').style.display = 'none';
            document.getElementById('form-step').style.display = 'block';
            
            // 清空表单
            document.getElementById('form').reset();
            
            // 清空签名板
            if (typeof customerSignaturePad !== 'undefined') {
                customerSignaturePad.clear();
            }
            if (typeof installerSignaturePad !== 'undefined') {
                installerSignaturePad.clear();
            }
            
            // 重置为默认日期
            document.getElementById('signature-date').value = new Date().toISOString().split('T')[0];
            
            // 恢复按钮显示
            document.getElementById('confirm-submit-btn').style.display = 'block';
            document.getElementById('edit-btn').style.display = 'block';
            
            // 滚动到顶部
            window.scrollTo(0, 0);
        }
    </script>

    <!-- 图片预览模态框 -->
    <div id="hintModal" class="modal-overlay hidden" onclick="closeHintModal()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">
                    <span class="lang-text" data-lang="en">Preview Image</span>
                    <span class="lang-text" data-lang="zh">预览图片</span>
                </h3>
                <button class="modal-close-btn" onclick="closeHintModal()" title="关闭">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalImageContainer" class="relative">
                    <div id="imageLoader" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg hidden">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                            <span class="text-sm text-gray-600">
                                <span class="lang-text" data-lang="en">Loading...</span>
                                <span class="lang-text" data-lang="zh">加载中...</span>
                            </span>
                        </div>
                    </div>
                    <img id="modalImage" src="" alt="预览图片" class="modal-image">
                </div>
            </div>
        </div>
    </div>
</body>
</html>